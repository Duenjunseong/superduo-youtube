{% extends "base.html" %}
{% load widget_tweaks %}

{% block title %}비디오 분할 대시보드{% endblock %}

{% block extra_css %}
<style>
    /* 대시보드 전체 컨테이너 최대 너비 설정 */
    .dashboard-container {
        max-width: 1440px; /* 요청된 최대 너비 */
        margin-left: auto;
        margin-right: auto;
    }

    .nav-tabs .nav-link.active {
        background-color: #f8f9fa;
        border-bottom-color: #f8f9fa;
    }
    .card-header {
        font-weight: bold;
    }
    .form-section-card {
        min-height: 300px; /* 우측 패널 카드 최소 높이 확보 */
    }
    .recent-jobs-list .list-group-item {
        font-size: 0.9rem;
    }
    .recent-jobs-list .badge {
        font-size: 0.75rem;
    }
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
    }
    .nav-tabs .nav-link.active {
        font-weight: bold;
    }
    /* 작업 목록 탭 내의 카드 스타일 (links.html 참조) */
    .job-card {
        margin-bottom: 15px;
        transition: all 0.3s ease;
    }
    .job-card:hover {
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    .job-actions { /* links.html의 스타일과 유사하게 */
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        gap: 10px;
    }
    .job-cards-container .col {
        display: flex; /* 카드 높이 동일하게 맞추기 위해 flex 사용 */
    }
    .job-card {
        width: 100%; /* col 내부에서 카드가 꽉 차도록 */
    }
    
    /* 작업 카드 버튼 개선 */
    .job-actions .btn-sm {
        min-width: 32px; /* 최소 너비 설정으로 아이콘만 있을 때도 일정한 크기 유지 */
        white-space: nowrap; /* 텍스트 줄바꿈 방지 */
    }
    
    /* 최근 작업 목록 버튼 개선 */
    .recent-jobs-list .btn-group-vertical .btn,
    .recent-jobs-list .btn-group .btn {
        min-width: 28px;
        white-space: nowrap;
    }
    
    /* 작은 화면에서 버튼 간격 조정 */
    @media (max-width: 768px) {
        .job-actions {
            gap: 5px;
        }
        .job-actions .btn-sm {
            padding: 0.25rem 0.4rem;
            font-size: 0.75rem;
        }
    }
    #status-filter-dropdown .dropdown-item.active {
        font-weight: bold;
        background-color: #e9ecef;
    }
    .tag-filter-pill {
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .tag-filter-pill:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .tag-filter-pill.active {
        background-color: #0d6efd !important; /* Bootstrap primary color */
        color: white !important;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container mt-4">
    <header class="text-center mb-4">
        <h1>Superduo Youtube</h1>
        <p class="lead">Youtube 채널 관리 도구</p>
    </header>

    <div class="row g-4">
        <!-- 좌측 패널: 그룹 및 최근 작업 -->
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>작업 그룹</span>
                    <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#createGroupModal">
                        <i class="fas fa-plus me-1"></i> 새 그룹 만들기
                    </button>
                </div>
                <div class="card-body" id="task-groups-list-container">
                    {% include 'video_processor/partials/task_group_list_partial.html' with task_groups=task_groups %}
                </div>
                 <div class="card-footer text-center">
                    <a href="{% url 'video_processor:group_list' %}" class="btn btn-sm btn-outline-secondary">모든 그룹 보기 <i class="fas fa-external-link-alt ms-1"></i></a>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    최근 제출 작업
                </div>
                <div class="card-body p-0" id="recent-jobs-list-container">
                    {% include 'video_processor/partials/recent_job_list_partial.html' with recent_jobs=recent_jobs %}
                </div>
            </div>
        </div>

        <!-- 우측 패널: 탭으로 구성 (작업 제출, 작업 목록 및 관리) -->
        <div class="col-lg-8">
            <ul class="nav nav-tabs mb-3" id="dashboardMainTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="submit-job-tab" data-bs-toggle="tab" data-bs-target="#submit-job-panel" type="button" role="tab" aria-controls="submit-job-panel" aria-selected="true">
                        <i class="fas fa-paper-plane me-2"></i>새 작업 제출
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="manage-jobs-tab" data-bs-toggle="tab" data-bs-target="#manage-jobs-panel" type="button" role="tab" aria-controls="manage-jobs-panel" aria-selected="false">
                        <i class="fas fa-list-check me-2"></i>작업 목록 및 관리
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="dashboardMainTabsContent">
                <!-- 작업 제출 탭 패널 -->
                <div class="tab-pane fade show active" id="submit-job-panel" role="tabpanel" aria-labelledby="submit-job-tab">
                    <div class="card form-section-card">
                        <div class="card-header">
                            비디오 정보 설정 및 작업 제출
                        </div>
                        <div class="card-body position-relative">
                            <div class="loading-overlay d-none">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            <form id="jobSubmitForm" method="post" action="{% url 'video_processor:job_submit' %}" novalidate>
                                {% csrf_token %}
                                <div id="job-submit-form-messages" class="mb-3"></div>
                                
                                <div class="mb-2">
                                    <label for="{{ form.youtube_url.id_for_label }}" class="form-label fw-bold">{{ form.youtube_url.label }}</label>
                                    {% render_field form.youtube_url class+="form-control form-control-lg" %}
                                    {% if form.youtube_url.help_text %}<div class="form-text">{{ form.youtube_url.help_text|safe }}</div>{% endif %}
                                    <div class="invalid-feedback d-block" id="error-youtube_url"></div>
                                </div>

                                {% if form.group %}
                                <div class="mb-2">
                                    <label for="{{ form.group.id_for_label }}" class="form-label">{{ form.group.label }}</label>
                                    {% render_field form.group class+="form-select" %}
                                    {% if form.group.help_text %}<div class="form-text">{{ form.group.help_text|safe }}</div>{% endif %}
                                    <div class="invalid-feedback d-block" id="error-group"></div>
                                </div>
                                {% endif %}
                                
                                <div class="mb-3">
                                    <div class="form-check">
                                        {% render_field form.download_full_video class+="form-check-input" %}
                                        <label for="{{ form.download_full_video.id_for_label }}" class="form-check-label fw-bold">
                                            {{ form.download_full_video.label }}
                                        </label>
                                        {% if form.download_full_video.help_text %}
                                            <div class="form-text">{{ form.download_full_video.help_text|safe }}</div>
                                        {% endif %}
                                        <div class="invalid-feedback d-block" id="error-download_full_video"></div>
                                    </div>
                                </div>

                                <div class="mb-2" id="full-video-prefix-container" style="display: none;">
                                    <label for="{{ form.full_video_prefix.id_for_label }}" class="form-label">{{ form.full_video_prefix.label }}</label>
                                    {% render_field form.full_video_prefix class+="form-control" %}
                                    {% if form.full_video_prefix.help_text %}<div class="form-text">{{ form.full_video_prefix.help_text|safe }}</div>{% endif %}
                                    <div class="invalid-feedback d-block" id="error-full_video_prefix"></div>
                                </div>
                                
                                <div class="mb-2" id="segments-input-container">
                                    <label for="{{ form.segments_input.id_for_label }}" class="form-label fw-bold">{{ form.segments_input.label }}</label>
                                    {% render_field form.segments_input class+="form-control" rows="5" %}
                                    {% if form.segments_input.help_text %}<div class="form-text">{{ form.segments_input.help_text|safe }}</div>{% endif %}
                                    <div class="form-text small bg-light p-2 rounded">
                                        <code>0:10-0:30 intro</code><br/><code>0:35-1:00 main_theme</code><br>
                                        <small class="text-muted">결과 파일명 접두사는 선택 사항입니다.</small>
                                    </div>
                                    <div class="invalid-feedback d-block" id="error-segments_input"></div>
                                </div>

                                <div class="row">
                                    <div class="col-md-8 mb-2">
                                        <label for="{{ form.tags_input.id_for_label }}" class="form-label">{{ form.tags_input.label }}</label>
                                        {% render_field form.tags_input class+="form-control" placeholder="예: 중요, 편집용, 발표자료" %}
                                        {% if form.tags_input.help_text %}<div class="form-text small">{{ form.tags_input.help_text|safe }}</div>{% endif %}
                                        <div class="invalid-feedback d-block" id="error-tags_input"></div>
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <div class="form-check mt-4 pt-2">
                                            {% render_field form.auto_start class+="form-check-input" %}
                                            <label for="{{ form.auto_start.id_for_label }}" class="form-check-label">
                                                {{ form.auto_start.label }}
                                            </label>
                                            {% if form.auto_start.help_text %}<div class="form-text small">{{ form.auto_start.help_text|safe }}</div>{% endif %}
                                            <div class="invalid-feedback d-block" id="error-auto_start"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="fas fa-rocket me-2"></i>처리 시작
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
            
                    <div class="card mt-4">
                        <div class="card-header">
                            현재 처리 개요 (실시간 업데이트)
                        </div>
                        <div class="card-body" id="processing-summary">
                            <p>현재 처리 중/대기 중인 내 작업: <span class="fw-bold"><i class="fas fa-spinner fa-spin"></i></span> 개</p>
                            <p>최근 24시간 내 완료된 내 작업: <span class="fw-bold"><i class="fas fa-spinner fa-spin"></i></span> 개</p>
                            <p class="mb-0">
                                <small class="text-muted">데이터를 불러오는 중...</small>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- 작업 목록 및 관리 탭 패널 -->
                <div class="tab-pane fade" id="manage-jobs-panel" role="tabpanel" aria-labelledby="manage-jobs-tab">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                            <span class="me-auto">내 모든 작업 목록 (<span id="total-jobs-count-display">{{ request.user.processing_jobs.count }}</span>개)</span>
                            <div class="btn-toolbar mt-2 mt-md-0" role="toolbar">
                                <form id="jobSearchForm" class="input-group input-group-sm me-2" role="search">
                                    <input type="search" id="jobSearchInput" class="form-control form-control-sm" placeholder="URL 또는 그룹명 검색..." aria-label="작업 검색">
                                    <button class="btn btn-outline-secondary" type="submit" title="검색"><i class="fas fa-search"></i></button>
                                </form>
                                <div class="input-group input-group-sm me-2">
                                    <label class="input-group-text visually-hidden" for="jobStatusFilter">상태</label>
                                    <select class="form-select form-select-sm" id="jobStatusFilter">
                                        <option value="">모든 상태</option>
                                        {% for code, display_name in job_status_choices %}
                                            <option value="{{ code }}" {% if code == current_status_filter %}selected{% endif %}>{{ display_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="input-group input-group-sm">
                                    <label class="input-group-text visually-hidden" for="jobSortBy">정렬</label>
                                    <select class="form-select form-select-sm" id="jobSortBy">
                                        <option value="-created_at" {% if current_sort_by == '-created_at' %}selected{% endif %}>최신순</option>
                                        <option value="created_at" {% if current_sort_by == 'created_at' %}selected{% endif %}>오래된순</option>
                                        <option value="status" {% if current_sort_by == 'status' %}selected{% endif %}>상태순</option>
                                        <option value="youtube_url" {% if current_sort_by == 'youtube_url' %}selected{% endif %}>URL순</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="tag-list-filter-container" class="mb-3">
                                <small class="text-muted me-2">태그 필터:</small>
                                <span id="tag-filter-pills">
                                    <span class="badge rounded-pill bg-light text-dark tag-filter-pill me-1 mb-1 {% if not current_tag_filter %}active{% endif %}" data-tag-name="">전체</span>
                                    {% for tag in available_tags %}
                                        <span class="badge rounded-pill bg-light text-dark tag-filter-pill me-1 mb-1 {% if tag.name == current_tag_filter %}active{% endif %}" data-tag-name="{{ tag.name }}">{{ tag.name }}</span>
                                    {% endfor %}
                                    {% if not available_tags %}<small class="text-muted fst-italic">사용된 태그가 없습니다.</small>{% endif %}
                                </span>
                                <!-- 태그 관리 버튼 (추후 구현) -->
                                {# <button class="btn btn-sm btn-outline-secondary ms-2" disabled title="태그 관리 (구현 예정)"><i class="fas fa-tags"></i></button> #}
                            </div>
                            <div id="job-list-container" class="mt-3">
                                <div class="text-center p-5 initial-load-spinner">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">작업 목록을 불러오는 중...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 새 그룹 만들기 모달 -->
<div class="modal fade" id="createGroupModal" tabindex="-1" aria-labelledby="createGroupModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createGroupModalLabel">새 작업 그룹 만들기</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="createGroupForm" method="post" action="{% url 'video_processor:group_create' %}">
        {% csrf_token %}
        <div class="modal-body position-relative">
            <div class="loading-overlay d-none">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            <div id="create-group-form-messages" class="mb-3"></div>
            <div class="mb-3">
                <label for="{{ task_group_form.name.id_for_label }}" class="form-label">{{ task_group_form.name.label }}</label>
                {% render_field task_group_form.name class+="form-control" %}
                {% if task_group_form.name.help_text %}<div class="form-text">{{ task_group_form.name.help_text|safe }}</div>{% endif %}
                <div class="invalid-feedback d-block" id="error-name"></div>
            </div>
            <div class="mb-3">
                <label for="{{ task_group_form.description.id_for_label }}" class="form-label">{{ task_group_form.description.label }}</label>
                {% render_field task_group_form.description class+="form-control" rows="3" %}
                {% if task_group_form.description.help_text %}<div class="form-text">{{ task_group_form.description.help_text|safe }}</div>{% endif %}
                <div class="invalid-feedback d-block" id="error-description"></div>
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="submit" class="btn btn-primary">그룹 생성</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const jobListContainer = document.getElementById('job-list-container');
    let isLoadingJobs = false;
    let currentJobPage = 1;
    let hasMoreJobs = true;
    const jobStatusFilter = document.getElementById('jobStatusFilter');
    const totalJobsCountDisplay = document.getElementById('total-jobs-count-display');
    const jobSearchForm = document.getElementById('jobSearchForm');
    const jobSearchInput = document.getElementById('jobSearchInput');
    const jobSortBy = document.getElementById('jobSortBy');
    const tagFilterPillsContainer = document.getElementById('tag-filter-pills');
    let currentSelectedTag = ''; // 현재 선택된 태그
    const recentJobsListContainer = document.getElementById('recent-jobs-list-container');
    
    // URL 패턴을 위한 변수
    const jobStartUrlPattern = '/video-processor/job/{job_id}/start/';

    // --- 유틸리티 함수 ---
    function showAlert(containerId, message, type = 'danger') {
        const alertContainer = document.getElementById(containerId);
        if (!alertContainer) return;
        
        // type에서 'alert-' 접두사가 있다면 제거
        const cleanType = type.replace(/^alert-/, '');
        
        const alertHtml = `<div class="alert alert-${cleanType} alert-dismissible fade show" role="alert">
                            ${message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>`;
        alertContainer.innerHTML = alertHtml;
    }

    function clearAlert(containerId) {
        const alertContainer = document.getElementById(containerId);
        if (alertContainer) alertContainer.innerHTML = '';
    }

    function setLoading(formElement, isLoading) {
        const overlay = formElement.closest('.position-relative')?.querySelector('.loading-overlay');
        if (overlay) {
            overlay.classList.toggle('d-none', !isLoading);
        }
        formElement.querySelectorAll('button[type="submit"]').forEach(button => button.disabled = isLoading);
    }
    
    function clearFormErrors(formElement) {
        formElement.querySelectorAll('.invalid-feedback').forEach(el => el.textContent = '');
        formElement.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
    }

    function displayFormErrors(formElement, errors) {
        clearFormErrors(formElement);
        for (const field in errors) {
            const errorElement = formElement.querySelector(`#error-${field}`);
            const fieldElement = formElement.querySelector(`[name="${field}"]`);
            if (errorElement) {
                errorElement.textContent = errors[field].join(', ');
            }
            if (fieldElement) {
                fieldElement.classList.add('is-invalid');
            }
        }
        if (errors.non_field_errors) {
            showAlert(formElement.id + '-messages', errors.non_field_errors.join(', '), 'danger');
        }
    }

    // --- 새 그룹 만들기 모달 처리 ---
    const createGroupForm = document.getElementById('createGroupForm');
    const createGroupModalEl = document.getElementById('createGroupModal');
    const createGroupModal = bootstrap.Modal.getOrCreateInstance(createGroupModalEl);

    if (createGroupForm) {
        createGroupForm.addEventListener('submit', function(event) {
            event.preventDefault();
            setLoading(createGroupForm, true);
            clearAlert('create-group-form-messages');
            clearFormErrors(createGroupForm);

            const formData = new FormData(createGroupForm);
            fetch(createGroupForm.action, {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('create-group-form-messages', '그룹이 성공적으로 생성되었습니다!', 'success');
                    // 그룹 목록 동적 업데이트
                    fetchTaskGroups(); 
                    setTimeout(() => {
                        createGroupModal.hide();
                        createGroupForm.reset();
                        clearAlert('create-group-form-messages');
                    }, 1500);
                } else if (data.errors) {
                    displayFormErrors(createGroupForm, data.errors);
                } else {
                    showAlert('create-group-form-messages', data.message || '그룹 생성에 실패했습니다.', 'danger');
                }
            })
            .catch(error => {
                console.error('Error creating group:', error);
                showAlert('create-group-form-messages', '그룹 생성 중 오류가 발생했습니다.', 'danger');
            })
            .finally(() => {
                setLoading(createGroupForm, false);
            });
        });
    }
    
    // 그룹 목록 동적 로드 및 업데이트 함수
    function fetchTaskGroups() {
        const container = document.getElementById('task-groups-list-container');
        if (!container) return;

        fetch("{% url 'video_processor:group_list' %}?partial=true", { // partial=true 쿼리 파라미터 추가
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.text()) // HTML을 텍스트로 받음
        .then(html => {
            container.innerHTML = html;
        })
        .catch(error => console.error('Error fetching task groups:', error));
    }


    // --- 작업 제출 폼 처리 ---
    const jobSubmitForm = document.getElementById('jobSubmitForm');
    if (jobSubmitForm) {
        // 전체 파일 다운로드 체크박스 이벤트 처리
        const downloadFullVideoCheckbox = document.getElementById('id_download_full_video');
        const segmentsInputContainer = document.getElementById('segments-input-container');
        const fullVideoPrefixContainer = document.getElementById('full-video-prefix-container');
        const segmentsInput = document.getElementById('id_segments_input');
        
        if (downloadFullVideoCheckbox && segmentsInputContainer && fullVideoPrefixContainer) {
            function toggleFields() {
                const isFullVideoChecked = downloadFullVideoCheckbox.checked;
                
                if (isFullVideoChecked) {
                    // 전체 파일 다운로드 체크 시
                    segmentsInputContainer.style.display = 'none';
                    fullVideoPrefixContainer.style.display = 'block';
                    segmentsInput.disabled = true;
                    segmentsInput.value = ''; // 세그먼트 입력 초기화
                } else {
                    // 전체 파일 다운로드 체크 해제 시
                    segmentsInputContainer.style.display = 'block';
                    fullVideoPrefixContainer.style.display = 'none';
                    segmentsInput.disabled = false;
                }
            }
            
            // 초기 상태 설정
            toggleFields();
            
            // 체크박스 변경 이벤트 리스너
            downloadFullVideoCheckbox.addEventListener('change', toggleFields);
        }
        
        jobSubmitForm.addEventListener('submit', function(event) {
            event.preventDefault();
            setLoading(jobSubmitForm, true);
            clearAlert('job-submit-form-messages');
            clearFormErrors(jobSubmitForm);

            const formData = new FormData(jobSubmitForm);
            fetch(jobSubmitForm.action, {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('job-submit-form-messages', data.message || '작업이 성공적으로 제출되었습니다!', 'success');
                    jobSubmitForm.reset();
                    fetchRecentJobs(true); // 작업 제출 성공 후 최근 작업 목록 업데이트
                    const activeTab = document.querySelector('#dashboardMainTabs .nav-link.active');
                    if (activeTab && activeTab.id === 'manage-jobs-tab') {
                         loadJobs(currentJobPage, false); // 현재 페이지 유지하면서 내용 추가/갱신
                    }
                } else if (data.errors) {
                    displayFormErrors(jobSubmitForm, data.errors);
                } else {
                    showAlert('job-submit-form-messages', data.message || '작업 제출에 실패했습니다.', 'danger');
                }
            })
            .catch(error => {
                console.error('Error submitting job:', error);
                showAlert('job-submit-form-messages', '작업 제출 중 오류가 발생했습니다.', 'danger');
            })
            .finally(() => {
                setLoading(jobSubmitForm, false);
            });
        });
    }

    // 최근 작업 목록 업데이트 함수
    function fetchRecentJobs(showSpinner = false) {
        if (!recentJobsListContainer) return;
        if (showSpinner) {
            recentJobsListContainer.innerHTML = '<div class="d-flex justify-content-center align-items-center p-3"><div class="spinner-border spinner-border-sm text-secondary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
        }
        
        fetch(`{% url 'video_processor:ajax_user_job_list' %}?recent=true&limit=5`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.text()) // HTML을 직접 받음
        .then(html => {
            recentJobsListContainer.innerHTML = html;
        })
        .catch(error => {
            console.error('Error fetching recent jobs:', error);
            recentJobsListContainer.innerHTML = '<p class="text-danger p-3">최근 작업 목록을 불러오는데 실패했습니다.</p>';
        });
    }
    
    function fetchProcessingSummary() {
        fetch(`{% url 'video_processor:ajax_processing_info' %}`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const processingSummaryContainer = document.getElementById('processing-summary');
                if (processingSummaryContainer) {
                    processingSummaryContainer.innerHTML = `
                        <p>현재 처리 중/대기 중인 내 작업: <span class="fw-bold text-primary">${data.processing_jobs_count}</span> 개</p>
                        <p>최근 24시간 내 완료된 내 작업: <span class="fw-bold text-success">${data.recent_completed_jobs_count}</span> 개</p>
                        <p class="mb-0">
                            <small class="text-muted">
                                실패한 작업: <span class="text-danger">${data.failed_jobs_count}</span>개 | 
                                전체 작업: <span class="text-info">${data.total_jobs_count}</span>개 |
                                마지막 업데이트: ${new Date().toLocaleTimeString()}
                            </small>
                        </p>
                    `;
                }
            }
        })
        .catch(error => {
            console.error('Error fetching processing summary:', error);
            const processingSummaryContainer = document.getElementById('processing-summary');
            if (processingSummaryContainer) {
                processingSummaryContainer.innerHTML = `
                    <p class="text-danger">처리 개요를 불러오는데 실패했습니다.</p>
                `;
            }
        });
    }

    // --- 작업 목록 관리 탭 기능 ---
    const manageJobsTab = document.getElementById('manage-jobs-tab');
    if (manageJobsTab) {
        manageJobsTab.addEventListener('shown.bs.tab', function (event) {
            if (jobListContainer.querySelector('.initial-load-spinner')) {
                loadJobs(1, true);
            }
        });
    }
    
    if (jobStatusFilter) {
        jobStatusFilter.addEventListener('change', function() {
            loadJobs(1, true); 
        });
    }

    if (jobSearchForm) {
        jobSearchForm.addEventListener('submit', function(event) {
            event.preventDefault();
            loadJobs(1, true);
        });
        // 검색창 내용이 비워졌을 때도 다시 로드 (옵션)
        jobSearchInput.addEventListener('search', function() {
            if (!jobSearchInput.value.trim()) {
                loadJobs(1, true);
            }
        });
    }

    if (jobSortBy) {
        jobSortBy.addEventListener("change", function() {
            loadJobs(1, true); // 정렬 변경 시 첫 페이지부터 새로 로드
        });
    }

    if (tagFilterPillsContainer) {
        tagFilterPillsContainer.addEventListener('click', function(event) {
            if (event.target.classList.contains('tag-filter-pill')) {
                tagFilterPillsContainer.querySelectorAll('.tag-filter-pill').forEach(pill => pill.classList.remove('active'));
                event.target.classList.add('active');
                currentSelectedTag = event.target.dataset.tagName;
                loadJobs(1, true); // 태그 필터 변경 시 첫 페이지부터 새로 로드
            }
        });
        // 초기 활성 태그 설정 (페이지 로드 시 URL 파라미터 등으로 설정된 경우 반영 위함)
        const initialActiveTagPill = tagFilterPillsContainer.querySelector('.tag-filter-pill.active');
        if (initialActiveTagPill) {
            currentSelectedTag = initialActiveTagPill.dataset.tagName;
        }
    }

    function loadJobs(page = 1, replaceCurrent = false) {
        if (isLoadingJobs || (!replaceCurrent && !hasMoreJobs && page > 1) ) return;
        isLoadingJobs = true;
        currentJobPage = page;

        const spinner = jobListContainer.querySelector('.initial-load-spinner');
        const loadMoreButton = jobListContainer.querySelector('.load-more-jobs-btn');
        if (loadMoreButton) loadMoreButton.disabled = true;
        if (spinner && page === 1 && replaceCurrent) spinner.classList.remove('d-none');
        
        let queryParams = `?page=${page}`;
        const selectedStatus = jobStatusFilter ? jobStatusFilter.value : '';
        if (selectedStatus) queryParams += `&status=${selectedStatus}`;
        
        const searchQuery = jobSearchInput ? jobSearchInput.value.trim() : '';
        if (searchQuery) queryParams += `&search=${encodeURIComponent(searchQuery)}`;

        const sortBy = jobSortBy ? jobSortBy.value : '-created_at';
        if (sortBy) queryParams += `&sort_by=${sortBy}`;

        if (currentSelectedTag) { // 선택된 태그가 있으면 파라미터 추가
            queryParams += `&tag=${encodeURIComponent(currentSelectedTag)}`;
        }
        
        fetch(`{% url 'video_processor:ajax_user_job_list' %}${queryParams}`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (spinner) spinner.classList.add('d-none');
                
                const jobCardsContainer = jobListContainer.querySelector('.job-cards-container');
                if (replaceCurrent || !jobCardsContainer) {
                    jobListContainer.innerHTML = data.html;
                } else {
                    if (loadMoreButton) loadMoreButton.parentElement.remove(); 
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = data.html;
                    const newCards = tempDiv.querySelector('.job-cards-container');
                    const newButtonContainer = tempDiv.querySelector('.load-more-jobs-btn')?.parentElement;

                    if (newCards) {
                        Array.from(newCards.children).forEach(cardCol => {
                            jobCardsContainer.appendChild(cardCol);
                        });
                    }
                    if (newButtonContainer) {
                        jobListContainer.appendChild(newButtonContainer);
                    }
                }
                hasMoreJobs = data.has_next;
                if (totalJobsCountDisplay && data.total_jobs !== undefined) { // total_jobs는 UserJobListView에서 전달 필요
                    totalJobsCountDisplay.textContent = data.total_jobs;
                }

                if (!hasMoreJobs && jobListContainer.querySelector('.load-more-jobs-btn')) {
                     const btn = jobListContainer.querySelector('.load-more-jobs-btn');
                     if(btn) btn.parentElement.innerHTML = '<p class="text-center text-muted mt-4"><small>모든 작업을 불러왔습니다.</small></p>';
                }
            } else {
                console.error("Error loading jobs:", data.error || data.message);
                if (page === 1) jobListContainer.innerHTML = `<p class="text-danger text-center">작업 목록을 불러오는데 실패했습니다: ${data.error || data.message || ''}</p>`;
            }
        })
        .catch(error => {
            console.error('Fetch error loading jobs:', error);
            if (page === 1) jobListContainer.innerHTML = '<p class="text-danger text-center">작업 목록 로드 중 오류 발생.</p>';
        })
        .finally(() => {
            isLoadingJobs = false;
            const newLoadMoreButton = jobListContainer.querySelector('.load-more-jobs-btn');
            if (newLoadMoreButton) newLoadMoreButton.disabled = false;
            // 초기 스피너가 여전히 있다면 (에러 등으로 인해 작업 목록이 로드되지 않은 경우) 숨김 처리
            if (spinner && !spinner.classList.contains('d-none') && !jobListContainer.querySelector('.job-cards-container')) {
                spinner.classList.add('d-none');
                if (!jobListContainer.textContent.trim()) { // 내용이 없으면 에러 메시지라도 표시
                     jobListContainer.innerHTML = '<p class="text-muted text-center">작업이 없거나 불러올 수 없습니다.</p>';
                }
            }
        });
    }

    // "더 보기" 버튼 이벤트 위임 (기존과 동일)
    jobListContainer.addEventListener('click', function(event) {
        if (event.target.classList.contains('load-more-jobs-btn')) {
            const nextPage = event.target.dataset.nextPage;
            if (nextPage) {
                loadJobs(parseInt(nextPage), false);
            }
        }
        
        // "시작" 버튼 클릭 이벤트 처리
        if (event.target.classList.contains('start-job-btn') || event.target.closest('.start-job-btn')) {
            const button = event.target.classList.contains('start-job-btn') ? event.target : event.target.closest('.start-job-btn');
            const jobId = button.dataset.jobId;
            
            if (!jobId) return;
            
            // 확인 대화상자
            if (!confirm('이 작업을 시작하시겠습니까?')) return;
            
            // 버튼 비활성화 및 로딩 상태 표시
            button.disabled = true;
            const originalContent = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 시작 중...';
            
            fetch(`${jobStartUrlPattern.replace('{job_id}', jobId)}`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 성공 시 버튼을 제거하고 상태 업데이트
                    button.remove();
                    // 작업 목록 새로고침
                    loadJobs(currentJobPage, true);
                    // 최근 작업 목록도 업데이트
                    fetchRecentJobs(true);
                    
                    // 성공 메시지 표시 (선택사항)
                    const alertContainer = document.createElement('div');
                    alertContainer.className = 'alert alert-success alert-dismissible fade show position-fixed';
                    alertContainer.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
                    alertContainer.innerHTML = `
                        ${data.message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    document.body.appendChild(alertContainer);
                    
                    // 3초 후 자동 제거
                    setTimeout(() => {
                        if (alertContainer.parentNode) {
                            alertContainer.remove();
                        }
                    }, 3000);
                } else {
                    // 실패 시 버튼 복원
                    button.disabled = false;
                    button.innerHTML = originalContent;
                    
                    // 에러 메시지 표시
                    const alertContainer = document.createElement('div');
                    alertContainer.className = 'alert alert-danger alert-dismissible fade show position-fixed';
                    alertContainer.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
                    alertContainer.innerHTML = `
                        ${data.message || '작업 시작에 실패했습니다.'}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    `;
                    document.body.appendChild(alertContainer);
                    
                    setTimeout(() => {
                        if (alertContainer.parentNode) {
                            alertContainer.remove();
                        }
                    }, 5000);
                }
            })
            .catch(error => {
                console.error('Error starting job:', error);
                // 에러 시 버튼 복원
                button.disabled = false;
                button.innerHTML = originalContent;
                
                // 에러 메시지 표시
                const alertContainer = document.createElement('div');
                alertContainer.className = 'alert alert-danger alert-dismissible fade show position-fixed';
                alertContainer.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
                alertContainer.innerHTML = `
                    작업 시작 중 오류가 발생했습니다.
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                document.body.appendChild(alertContainer);
                
                setTimeout(() => {
                    if (alertContainer.parentNode) {
                        alertContainer.remove();
                    }
                }, 5000);
            });
        }
    });

    // 초기 데이터 로드 (기존)
    fetchProcessingSummary();
    // fetchTaskGroups(); // 대시보드 로드 시 그룹 목록은 이미 context로 전달받으므로 초기 AJAX 호출 불필요. 생성/삭제 시에만 호출.

    // 1초마다 처리 개요 업데이트
    setInterval(fetchProcessingSummary, 5000);

});
</script>
{% endblock %} 