{% extends "base.html" %}
{% load widget_tweaks %}

{% block title %}
{% if current_workspace %}
{{ current_workspace.name }} - 대시보드
{% else %}
개인 대시보드
{% endif %}
{% endblock %}

{% block extra_css %}
<!-- Flatpickr CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<style>
    /* 대시보드 전체 컨테이너 최대 너비 설정 */
    .dashboard-container {
        max-width: 1440px; /* 요청된 최대 너비 */
        margin-left: auto;
        margin-right: auto;
    }

    /* 워크스페이스 인디케이터 개선 - 프리미엄 디자인 */
    .workspace-indicator {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
        box-shadow: 0 20px 40px rgba(102, 126, 234, 0.15), 
                    0 8px 24px rgba(102, 126, 234, 0.12);
        border: 1px solid rgba(255, 255, 255, 0.18);
    }
    
    .workspace-indicator::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, 
            rgba(255, 255, 255, 0.1) 0%, 
            rgba(255, 255, 255, 0.05) 50%, 
            rgba(255, 255, 255, 0.02) 100%);
        pointer-events: none;
    }
    
    .workspace-indicator .workspace-content {
        position: relative;
        z-index: 1;
        color: white;
    }
    
    .workspace-indicator h4 {
        font-weight: 600;
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .workspace-indicator p {
        opacity: 0.85;
        font-weight: 400;
        font-size: 0.95rem;
        line-height: 1.5;
    }
    
    .workspace-indicator .btn {
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        font-weight: 500;
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
    }
    
    .workspace-indicator .btn:hover {
        background: rgba(255, 255, 255, 0.25);
        border-color: rgba(255, 255, 255, 0.3);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }
    
    /* 개인 모드 인디케이터 - 다른 색상 조합으로 구분 */
    .personal-indicator {
        background: linear-gradient(135deg, #ee7752 0%, #e73c7e 50%, #23a6d5 100%);
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
        box-shadow: 0 20px 40px rgba(238, 119, 82, 0.15), 
                    0 8px 24px rgba(238, 119, 82, 0.12);
        border: 1px solid rgba(255, 255, 255, 0.18);
    }
    
    .personal-indicator::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(135deg, 
            rgba(255, 255, 255, 0.1) 0%, 
            rgba(255, 255, 255, 0.05) 50%, 
            rgba(255, 255, 255, 0.02) 100%);
        pointer-events: none;
    }
    
    .personal-indicator .workspace-content {
        position: relative;
        z-index: 1;
        color: white;
    }
    
    .personal-indicator h4 {
        font-weight: 600;
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    .personal-indicator p {
        opacity: 0.85;
        font-weight: 400;
        font-size: 0.95rem;
        line-height: 1.5;
    }
    
    .personal-indicator .btn {
        background: rgba(255, 255, 255, 0.15);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: white;
        font-weight: 500;
        padding: 0.75rem 1.5rem;
        border-radius: 12px;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
    }
    
    .personal-indicator .btn:hover {
        background: rgba(255, 255, 255, 0.25);
        border-color: rgba(255, 255, 255, 0.3);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
    }

    /* 카드 디자인 개선 */
    .card {
        border: none;
        border-radius: 16px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        background: white;
        overflow: hidden;
    }
    
    .card:hover {
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        transform: translateY(-2px);
    }

    .card-header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        font-weight: 600;
        padding: 1.25rem 1.5rem;
        font-size: 0.95rem;
        color: #495057;
    }

    .card-body {
        padding: 1.5rem;
    }

    .card-footer {
        background: #f8f9fa;
        border-top: 1px solid rgba(0, 0, 0, 0.05);
        padding: 1rem 1.5rem;
    }

    /* 폼 섹션 카드 스타일 개선 */
    .form-section-card {
        min-height: 300px;
        background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    }

    /* 네비게이션 탭 개선 */
    .nav-tabs {
        border-bottom: 2px solid #e9ecef;
        margin-bottom: 1.5rem;
        display: flex;
        flex-wrap: wrap;
        justify-content: flex-start; /* 왼쪽 정렬 */
        gap: 0.5rem; /* 탭 간격 조정 */
    }
    
    .nav-tabs .nav-item {
        flex: none; /* flex-grow 방지 */
        margin-bottom: 0;
    }
    
    .nav-tabs .nav-link {
        border: none;
        border-radius: 12px 12px 0 0;
        color: #6c757d;
        font-weight: 500;
        padding: 1rem 1.2rem; /* 좌우 패딩 약간 줄임 */
        margin-right: 0; /* margin-right 제거 */
        transition: all 0.3s ease;
        background: transparent;
        white-space: nowrap; /* 텍스트 줄바꿈 방지 */
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .nav-tabs .nav-link:hover {
        border-color: transparent;
        color: #495057;
        background: rgba(0, 123, 255, 0.05);
    }
    
    .nav-tabs .nav-link.active {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        border-color: transparent;
        font-weight: 600;
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }

    /* 버튼 스타일 개선 */
    .btn {
        border-radius: 10px;
        font-weight: 500;
        transition: all 0.3s ease;
        border: none;
        position: relative;
        overflow: hidden;
    }

    .btn-primary {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }
    
    .btn-primary:hover {
        background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
    }

    .btn-success {
        background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }
    
    .btn-success:hover {
        background: linear-gradient(135deg, #1e7e34 0%, #155724 100%);
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
    }

    /* 폼 컨트롤 개선 */
    .form-control, .form-select {
        border-radius: 10px;
        border: 2px solid #e9ecef;
        padding: 0.75rem 1rem;
        transition: all 0.3s ease;
        font-size: 0.95rem;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.15);
        transform: translateY(-1px);
    }

    /* 최근 작업 목록 스타일 개선 */
    .recent-jobs-list .list-group-item {
        font-size: 0.9rem;
        border: none;
        border-radius: 8px !important;
        margin-bottom: 0.5rem;
        background: #f8f9fa;
        transition: all 0.3s ease;
    }
    
    .recent-jobs-list .list-group-item:hover {
        background: #e9ecef;
        transform: translateX(4px);
    }
    
    .recent-jobs-list .badge {
        font-size: 0.75rem;
        border-radius: 6px;
        font-weight: 500;
    }

    /* 로딩 오버레이 개선 */
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(4px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        border-radius: 16px;
    }

    /* 작업 카드 관련 스타일 개선 */
    .job-card {
        margin-bottom: 15px;
        transition: all 0.3s ease;
        border-radius: 16px;
        overflow: hidden;
    }
    
    .job-card:hover {
        box-shadow: 0 8px 30px rgba(0,0,0,0.12);
        transform: translateY(-4px);
    }
    
    .job-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .job-cards-container .col {
        display: flex;
    }
    
    .job-card {
        width: 100%;
        display: flex;
        flex-direction: column;
    }
    
    /* 작업 카드 버튼 개선 */
    .job-actions .btn-sm {
        min-width: 36px;
        white-space: nowrap;
        border-radius: 8px;
        font-weight: 500;
    }
    
    /* 최근 작업 목록 버튼 개선 */
    .recent-jobs-list .btn-group-vertical .btn,
    .recent-jobs-list .btn-group .btn {
        min-width: 32px;
        white-space: nowrap;
        border-radius: 6px;
    }
    
    /* 태그 필터 개선 */
    .tag-filter-pill {
        cursor: pointer;
        transition: all 0.3s ease;
        border-radius: 20px !important;
        font-weight: 500;
        border: 2px solid transparent;
    }
    
    .tag-filter-pill:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .tag-filter-pill.active {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
        color: white !important;
        font-weight: 600;
        border-color: #007bff;
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }

    /* 헤더 스타일 개선 */
    header h1 {
        font-weight: 700;
        color: #2c3e50;
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }
    
    header .lead {
        color: #6c757d;
        font-size: 1.2rem;
        font-weight: 400;
    }

    /* 반응형 개선 */
    @media (max-width: 768px) {
        .workspace-indicator, .personal-indicator {
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .workspace-indicator h4, .personal-indicator h4 {
            font-size: 1.3rem;
        }
        
        .workspace-indicator .btn, .personal-indicator .btn {
            padding: 0.6rem 1.2rem;
            font-size: 0.9rem;
        }
        
        /* 탭 네비게이션 반응형 */
        .nav-tabs {
            gap: 0.25rem;
        }
        
        .nav-tabs .nav-link {
            padding: 0.75rem 1rem;
            font-size: 0.9rem;
        }
        
        .nav-tabs .nav-link i {
            font-size: 0.85rem;
        }
        
        .job-actions {
            gap: 8px;
        }
        
        .job-actions .btn-sm {
            padding: 0.35rem 0.6rem;
            font-size: 0.8rem;
        }
        
        .card-header {
            padding: 1rem 1.25rem;
            font-size: 0.9rem;
        }
        
        .card-body {
            padding: 1.25rem;
        }
    }

    @media (max-width: 576px) {
        /* 모바일에서 탭 텍스트 축약 */
        .nav-tabs .nav-link {
            padding: 0.6rem 0.8rem;
            font-size: 0.85rem;
        }
        
        .nav-tabs .nav-link span {
            display: none; /* 아이콘만 표시 */
        }
        
        .nav-tabs .nav-link i {
            margin-right: 0 !important;
            font-size: 1rem;
        }
    }

    /* 상태 필터 드롭다운 개선 */
    #status-filter-dropdown .dropdown-item.active {
        font-weight: 600;
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
    }

    /* 처리 개요 카드 개선 */
    #processing-summary {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 12px;
        padding: 1.5rem;
    }
    
    #processing-summary p {
        margin-bottom: 0.75rem;
        font-size: 1rem;
    }
    
    #processing-summary .fw-bold {
        color: #007bff;
        font-size: 1.1rem;
    }

    /* 인기 쇼츠 스타일 */
    .shorts-card {
        border: none;
        border-radius: 12px;
        overflow: hidden;
        transition: all 0.3s ease;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        margin-bottom: 1rem;
    }
    
    .shorts-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    
    .shorts-thumbnail {
        position: relative;
        overflow: hidden;
        aspect-ratio: 9/16; /* 쇼츠 비율 */
        background: #000;
    }
    
    .shorts-thumbnail img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }
    
    .shorts-card:hover .shorts-thumbnail img {
        transform: scale(1.05);
    }
    
    .shorts-rank-badge {
        position: absolute;
        top: 8px;
        left: 8px;
        background: linear-gradient(135deg, #ff4757 0%, #ff3742 100%);
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .shorts-duration {
        position: absolute;
        bottom: 8px;
        right: 8px;
        background: rgba(0,0,0,0.8);
        color: white;
        padding: 0.2rem 0.4rem;
        border-radius: 4px;
        font-size: 0.7rem;
        font-weight: 500;
    }
    
    .shorts-info {
        padding: 1rem;
    }
    
    .shorts-title {
        font-size: 0.9rem;
        font-weight: 600;
        line-height: 1.3;
        margin-bottom: 0.5rem;
        color: #2c3e50;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        word-break: break-word;
        max-height: 2.6em; /* 2줄 제한 */
    }
    
    .shorts-channel {
        font-size: 0.8rem;
        color: #6c757d;
        margin-bottom: 0.5rem;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100%;
    }
    
    .shorts-stats {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.75rem;
        color: #495057;
        gap: 0.5rem;
        flex-wrap: wrap;
    }
    
    .shorts-views {
        font-weight: 500;
        color: #495057; /* 기본 텍스트 컬러로 변경 */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        flex: 1;
        min-width: 0;
    }
    
    .shorts-likes {
        font-weight: 500;
        color: #e91e63;
        white-space: nowrap;
        font-size: 0.7rem;
        margin-right: 0.25rem;
    }
    
    .shorts-comments {
        font-weight: 500;
        color: #2196f3;
        white-space: nowrap;
        font-size: 0.7rem;
        margin-right: 0.25rem;
    }
    
    .shorts-category {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
        padding: 0.2rem 0.5rem;
        border-radius: 8px;
        font-size: 0.7rem;
        font-weight: 500;
        display: inline-block;
        white-space: nowrap;
    }
    
    /* 카드와 테이블에서 공통으로 사용되는 카테고리 뱃지 */
    .category-badge {
        color: white;
        padding: 0.25rem 0.5rem;
        border-radius: 8px;
        font-size: 0.7rem;
        font-weight: 500;
        display: inline-block;
        white-space: nowrap;
        text-align: center;
        min-width: 50px;
    }
    
    .shorts-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 1rem;
    }
    
    .shorts-load-more {
        text-align: center;
        margin-top: 2rem;
    }
    
    /* 빈 상태 스타일 */
    .shorts-empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #6c757d;
    }
    
    .shorts-empty-state i {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    /* 로딩 스타일 */
    .shorts-loading-card {
        background: #f8f9fa;
        border-radius: 12px;
        overflow: hidden;
        margin-bottom: 1rem;
        position: relative;
    }
    
    .shorts-loading-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.6), transparent);
        animation: loading-shimmer 1.5s infinite;
    }
    
    @keyframes loading-shimmer {
        0% { left: -100%; }
        100% { left: 100%; }
    }
    
    .shorts-loading-thumbnail {
        aspect-ratio: 9/16;
        background: #e9ecef;
    }
    
    .shorts-loading-info {
        padding: 1rem;
    }
    
    .shorts-loading-title {
        height: 1rem;
        background: #e9ecef;
        border-radius: 4px;
        margin-bottom: 0.5rem;
    }
    
    .shorts-loading-channel {
        height: 0.8rem;
        background: #e9ecef;
        border-radius: 4px;
        width: 60%;
        margin-bottom: 0.5rem;
    }
    
    .shorts-loading-stats {
        height: 0.7rem;
        background: #e9ecef;
        border-radius: 4px;
        width: 40%;
    }
    
    /* 응답형 디자인 */
    @media (max-width: 576px) {
        .shorts-grid {
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 0.75rem;
        }
        
        .shorts-info {
            padding: 0.75rem;
        }
        
        .shorts-title {
            font-size: 0.85rem;
        }
        
        .shorts-channel {
            font-size: 0.75rem;
        }
    }
    
    /* 테이블 형태 스타일 개선 */
    .shorts-table {
        width: 100%;
        margin-bottom: 0;
        border-collapse: separate;
        border-spacing: 0;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .shorts-table th {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: none;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        color: #495057;
        padding: 1rem 0.75rem;
        font-size: 0.85rem;
        text-align: center;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    
    .shorts-table th:first-child {
        text-align: center;
        width: 80px;
    }
    
    .shorts-table th:nth-child(2) {
        width: 100px;
    }
    
    .shorts-table th:nth-child(3) {
        text-align: left;
        width: auto;
        min-width: 300px;
    }
    
    .shorts-table th:nth-child(4) {
        width: 120px;
    }
    
    .shorts-table th:nth-child(5) {
        width: 100px;
    }
    
    .shorts-table th:nth-child(6) {
        width: 80px;
    }
    
    .shorts-table td {
        padding: 0.875rem 0.75rem;
        border-bottom: 1px solid #f1f3f5;
        vertical-align: middle;
        font-size: 0.85rem;
        text-align: center;
    }
    
    .shorts-table tbody tr {
        transition: all 0.2s ease;
        cursor: pointer;
    }
    
    .shorts-table tbody tr:hover {
        background-color: #f8f9fa;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .shorts-table tbody tr:last-child td {
        border-bottom: none;
    }
    
    .rank-cell {
        font-weight: 700;
        color: #dc3545;
        font-size: 1rem;
        text-align: center !important;
    }
    
    .thumbnail-cell {
        text-align: center !important;
        padding: 0.5rem !important;
    }
    
    .thumbnail-small {
        width: 60px;
        height: 80px;
        object-fit: cover;
        border-radius: 6px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .title-cell {
        text-align: left !important;
        max-width: 300px;
    }
    
    .title-text {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0.25rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        text-overflow: ellipsis;
        line-height: 1.3;
    }
    
    .channel-text {
        font-size: 0.75rem;
        color: #6c757d;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .views-cell {
        font-weight: 600;
        color: #495057;
        white-space: nowrap;
    }
    
    .likes-cell {
        font-weight: 600;
        color: #e91e63;
        white-space: nowrap;
        text-align: center !important;
        width: 80px;
    }
    
    .comments-cell {
        font-weight: 600;
        color: #2196f3;
        white-space: nowrap;
        text-align: center !important;
        width: 80px;
    }
    
    .category-cell {
        text-align: center !important;
    }
    
    .duration-cell {
        font-weight: 500;
        color: #6c757d;
        font-family: 'Courier New', monospace;
    }
    
    /* 순위 변동 표시 */
    .rank-change {
        display: inline-block;
        font-size: 0.65rem;
        font-weight: 600;
        padding: 0.15rem 0.3rem;
        border-radius: 10px;
        margin-left: 0.25rem;
        vertical-align: middle;
    }
    
    .rank-change.up {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
    }
    
    .rank-change.up::before {
        content: '↑';
        margin-right: 0.15rem;
    }
    
    .rank-change.down {
        background: linear-gradient(135deg, #dc3545 0%, #e74c3c 100%);
        color: white;
    }
    
    .rank-change.down::before {
        content: '↓';
        margin-right: 0.15rem;
    }
    
    .rank-change.same {
        background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        color: white;
    }
    
    .rank-change.same::before {
        content: '=';
        margin-right: 0.15rem;
    }
    
    .new-badge {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
        color: white;
        font-size: 0.6rem;
        font-weight: 700;
        padding: 0.2rem 0.4rem;
        border-radius: 12px;
        margin-left: 0.25rem;
        vertical-align: middle;
        animation: pulse-glow 2s infinite;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    @keyframes pulse-glow {
        0%, 100% {
            box-shadow: 0 0 5px rgba(255, 107, 107, 0.5);
        }
        50% {
            box-shadow: 0 0 15px rgba(255, 107, 107, 0.8);
        }
    }
    
    /* 보기 방식 토글 */
    .btn-check:checked + .btn-outline-secondary {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        border-color: #007bff;
        color: white;
    }
    
    .btn-outline-secondary:hover {
        background: rgba(0, 123, 255, 0.1);
        border-color: #007bff;
        color: #007bff;
    }
    
    /* 음악 필터 스위치 */
    .form-check-input:checked {
        background-color: #007bff;
        border-color: #007bff;
    }
    
    .form-check-input:focus {
        border-color: #007bff;
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(0, 123, 255, 0.25);
    }
    
    /* 테이블 반응형 */
    @media (max-width: 768px) {
        .shorts-stats {
            font-size: 0.7rem;
            gap: 0.25rem;
        }
        
        .shorts-likes, .shorts-comments {
            font-size: 0.65rem;
        }
        
        .shorts-table th:nth-child(5), 
        .shorts-table th:nth-child(6) {
            width: 70px;
        }
        
        .likes-cell, .comments-cell {
            width: 70px;
            font-size: 0.75rem;
        }
        
        .shorts-table .title-cell {
            max-width: 200px;
        }
        
        .shorts-table .views-cell {
            width: 100px;
        }
        
        .shorts-table .category-cell {
            width: 80px;
        }
        
        .shorts-table .category-badge {
            font-size: 0.6rem;
            padding: 0.2rem 0.4rem;
        }
        
        .shorts-table .duration-cell {
            width: 70px;
        }
        
        .shorts-table td {
            padding: 0.5rem;
            font-size: 0.8rem;
        }
        
        .rank-change {
            font-size: 0.6rem;
            padding: 0.1rem 0.3rem;
        }
        
        .new-badge {
            font-size: 0.6rem;
            padding: 0.1rem 0.3rem;
        }
    }
    
    /* 테이블 컨테이너 */
    .table-responsive {
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    /* 카테고리별 컬러 정의 */
    .category-badge.entertainment { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
    .category-badge.music { background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); }
    .category-badge.gaming { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); }
    .category-badge.sports { background: linear-gradient(135deg, #e67e22 0%, #d35400 100%); }
    .category-badge.news { background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%); }
    .category-badge.education { background: linear-gradient(135deg, #16a085 0%, #138d75 100%); }
    .category-badge.tech { background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); }
    .category-badge.comedy { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); }
    .category-badge.lifestyle { background: linear-gradient(135deg, #e91e63 0%, #ad1457 100%); }
    .category-badge.other { background: linear-gradient(135deg, #6c757d 0%, #495057 100%); }
    
    /* 썸네일 9:16 비율 적용 */
    .shorts-thumbnail {
        aspect-ratio: 9/16;
        width: 100%;
        object-fit: cover;
        border-radius: 8px;
        transition: transform 0.2s ease;
    }
    
    .shorts-card:hover .shorts-thumbnail {
        transform: scale(1.05);
    }
    
    /* 테이블에서 썸네일 크기 조정 */
    .shorts-table .thumbnail-small {
        width: 45px;
        height: 80px;
        object-fit: cover;
        border-radius: 4px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* 태그 추출 기능 스타일 */
    .tags-list {
        max-height: 500px;
        overflow-y: auto;
    }
    
    .tag-item {
        display: inline-block;
        margin: 0.25rem 0.25rem 0.25rem 0;
        padding: 0.5rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        border: 1px solid transparent;
        position: relative;
        animation: tagFadeIn 0.5s ease forwards;
        opacity: 0;
        transform: translateY(10px);
    }
    
    .tag-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .tag-item.selected {
        background: #007bff;
        color: white;
        border-color: #0056b3;
        box-shadow: 0 4px 12px rgba(0,123,255,0.3);
    }
    
    /* 태그 카테고리별 색상 */
    .tag-korean {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        color: white;
    }
    
    .tag-tech {
        background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
        color: white;
    }
    
    .tag-music {
        background: linear-gradient(135deg, #a8e6cf 0%, #7fcdcd 100%);
        color: white;
    }
    
    .tag-gaming {
        background: linear-gradient(135deg, #ffd93d 0%, #ff6b6b 100%);
        color: white;
    }
    
    .tag-entertainment {
        background: linear-gradient(135deg, #ff8a80 0%, #ff5722 100%);
        color: white;
    }
    
    .tag-general {
        background: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
        color: white;
    }
    
    @keyframes tagFadeIn {
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* 태그 추출 로딩 오버레이 */
    .tag-extractor-loading {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        border-radius: 12px;
    }
    
    #copy-all-tags-btn:hover {
        background: #007bff;
        color: white;
        border-color: #007bff;
    }

    /* 비디오 정보 카드 */
    .video-info-card {
        border: none;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: all 0.3s ease;
    }
    
    .video-info-card:hover {
        box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        transform: translateY(-2px);
    }
    
    /* 태그 추출 폼 */
    #tag-extract-form .input-group {
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    
    #tag-extract-form .form-control {
        border: none;
        font-size: 0.9rem;
    }
    
    #tag-extract-form .form-control:focus {
        box-shadow: none;
        border-color: transparent;
    }
    
    #extract-tags-btn {
        border: none;
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    #extract-tags-btn:hover {
        background: linear-gradient(135deg, #0056b3 0%, #004085 100%);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
    }
    
    /* 태그 카운트 배지 */
    #tags-count {
        font-size: 0.7rem;
        border-radius: 12px;
        padding: 0.3rem 0.6rem;
        font-weight: 600;
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }
    
    /* 반응형 개선 */
    @media (max-width: 992px) {
        .tag-item {
            font-size: 0.75rem;
            padding: 0.3rem 0.6rem;
        }
        
        .tags-list {
            max-height: 200px;
        }
        
        #video-thumb-img {
            max-height: 80px !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="dashboard-container mt-4">
    <!-- 워크스페이스 인디케이터 -->
    {% if current_workspace %}
    <div class="workspace-indicator">
        <div class="workspace-content d-flex justify-content-between align-items-center">
            <div class="flex-grow-1">
                <h4 class="mb-2 d-flex align-items-center">
                    {% if current_workspace.icon %}
                        <img src="{{ current_workspace.icon.url }}" alt="{{ current_workspace.name }} 아이콘" 
                             class="workspace-icon me-3" style="width: 48px; height: 48px; border-radius: 12px; object-fit: cover; border: 2px solid rgba(255,255,255,0.3);">
                    {% else %}
                        <i class="fas fa-building me-3"></i>
                    {% endif %}
                    {{ current_workspace.name }}
                </h4>
                <p class="mb-0">
                    현재 {{ current_workspace.name }} 워크스페이스에서 작업하고 있습니다.
                </p>
            </div>
            <div class="ms-4">
                <a href="{% url 'workspace:workspace_detail' workspace_id=current_workspace.workspace_id %}" 
                   class="btn">
                    <i class="fas fa-cog me-2"></i> 워크스페이스 관리
                </a>
            </div>
        </div>
    </div>
    {% else %}
    <div class="personal-indicator">
        <div class="workspace-content d-flex justify-content-between align-items-center">
            <div class="flex-grow-1">
                <h4 class="mb-2 d-flex align-items-center">
                    <i class="fas fa-user me-3"></i> 개인 작업 공간
                </h4>
                <p class="mb-0">
                    개인 모드에서 자신만의 작업을 관리하고 있습니다.
                </p>
            </div>
            <div class="ms-4">
                <a href="{% url 'workspace:workspace_list' %}" class="btn">
                    <i class="fas fa-building me-2"></i> 워크스페이스 보기
                </a>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row g-4">
        <!-- 좌측 패널: 그룹 및 최근 작업 -->
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                    <h6 class="mb-0 fw-semibold d-flex align-items-center flex-grow-1 me-3">
                        {% if current_workspace %}
                            <i class="fas fa-folder me-2"></i>{{ current_workspace.name }} 작업 그룹
                        {% else %}
                            <i class="fas fa-user-folder me-2"></i>개인 작업 그룹
                        {% endif %}
                    </h6>
                    {% if can_create_group %}
                    <button type="button" class="btn btn-sm btn-success flex-shrink-0" data-bs-toggle="modal" data-bs-target="#createGroupModal">
                        <i class="fas fa-plus me-1"></i><span class="d-none d-lg-inline"> 새 그룹</span>
                    </button>
                    {% else %}
                    <small class="text-muted flex-shrink-0 badge bg-light">그룹 생성 권한 없음</small>
                    {% endif %}
                </div>
                <div class="card-body" id="task-groups-list-container">
                    {% include 'video_processor/partials/task_group_list_partial.html' with task_groups=task_groups %}
                </div>
                 <div class="card-footer text-center">
                    <a href="{% url 'video_processor:group_list' %}" class="btn btn-sm btn-outline-secondary">모든 그룹 보기 <i class="fas fa-external-link-alt ms-1"></i></a>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0 fw-semibold d-flex align-items-center">
                        {% if current_workspace %}
                            <i class="fas fa-clock me-2"></i>{{ current_workspace.name }} 최근 작업
                        {% else %}
                            <i class="fas fa-history me-2"></i>개인 최근 작업
                        {% endif %}
                    </h6>
                </div>
                <div class="card-body p-0" id="recent-jobs-list-container">
                    {% include 'video_processor/partials/recent_job_list_partial.html' with recent_jobs=recent_jobs %}
                </div>
            </div>
        </div>

        <!-- 우측 패널: 탭으로 구성 (작업 제출, 작업 목록 및 관리, 인기 쇼츠) -->
        <div class="col-lg-8">
            <ul class="nav nav-tabs mb-3" id="dashboardMainTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="submit-job-tab" data-bs-toggle="tab" data-bs-target="#submit-job-panel" type="button" role="tab" aria-controls="submit-job-panel" aria-selected="true">
                        <i class="fas fa-paper-plane me-2"></i><span>새 작업 제출</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="manage-jobs-tab" data-bs-toggle="tab" data-bs-target="#manage-jobs-panel" type="button" role="tab" aria-controls="manage-jobs-panel" aria-selected="false">
                        <i class="fas fa-tasks me-2"></i><span>작업 목록 및 관리</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="trending-shorts-tab" data-bs-toggle="tab" data-bs-target="#trending-shorts-panel" type="button" role="tab" aria-controls="trending-shorts-panel" aria-selected="false">
                        <i class="fab fa-youtube me-2"></i><span>인기 쇼츠</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tag-extractor-tab" data-bs-toggle="tab" data-bs-target="#tag-extractor-panel" type="button" role="tab" aria-controls="tag-extractor-panel" aria-selected="false">
                        <i class="fas fa-tags me-2"></i><span>태그 추출</span>
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="dashboardMainTabsContent">
                <!-- 작업 제출 탭 패널 -->
                <div class="tab-pane fade show active" id="submit-job-panel" role="tabpanel" aria-labelledby="submit-job-tab">
                    <div class="card form-section-card">
                        <div class="card-header">
                            <h6 class="mb-0 fw-semibold d-flex align-items-center">
                                <i class="fas fa-paper-plane me-2"></i>
                                {% if current_workspace %}
                                    {{ current_workspace.name }} 워크스페이스에 작업 제출
                                {% else %}
                                    개인 작업 제출
                                {% endif %}
                            </h6>
                        </div>
                        <div class="card-body position-relative">
                            <div class="loading-overlay d-none">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                            <form id="jobSubmitForm" method="post" action="{% url 'video_processor:job_submit' %}" novalidate>
                                {% csrf_token %}
                                <div id="job-submit-form-messages" class="mb-3"></div>
                                
                                <div class="mb-2">
                                    <label for="{{ form.youtube_url.id_for_label }}" class="form-label fw-bold">{{ form.youtube_url.label }}</label>
                                    {% render_field form.youtube_url class+="form-control form-control-lg" %}
                                    {% if form.youtube_url.help_text %}<div class="form-text">{{ form.youtube_url.help_text|safe }}</div>{% endif %}
                                    <div class="invalid-feedback d-block" id="error-youtube_url"></div>
                                </div>

                                {% if form.group %}
                                <div class="mb-2">
                                    <label for="{{ form.group.id_for_label }}" class="form-label">{{ form.group.label }}</label>
                                    {% render_field form.group class+="form-select" %}
                                    {% if form.group.help_text %}<div class="form-text">{{ form.group.help_text|safe }}</div>{% endif %}
                                    <div class="invalid-feedback d-block" id="error-group"></div>
                                </div>
                                {% endif %}
                                
                                <div class="mb-3">
                                    <div class="form-check">
                                        {% render_field form.download_full_video class+="form-check-input" %}
                                        <label for="{{ form.download_full_video.id_for_label }}" class="form-check-label fw-bold">
                                            {{ form.download_full_video.label }}
                                        </label>
                                        {% if form.download_full_video.help_text %}
                                            <div class="form-text">{{ form.download_full_video.help_text|safe }}</div>
                                        {% endif %}
                                        <div class="invalid-feedback d-block" id="error-download_full_video"></div>
                                    </div>
                                </div>

                                <div class="mb-2" id="full-video-prefix-container" style="display: none;">
                                    <label for="{{ form.full_video_prefix.id_for_label }}" class="form-label">{{ form.full_video_prefix.label }}</label>
                                    {% render_field form.full_video_prefix class+="form-control" %}
                                    {% if form.full_video_prefix.help_text %}<div class="form-text">{{ form.full_video_prefix.help_text|safe }}</div>{% endif %}
                                    <div class="invalid-feedback d-block" id="error-full_video_prefix"></div>
                                </div>
                                
                                <div class="mb-2" id="segments-input-container">
                                    <label for="{{ form.segments_input.id_for_label }}" class="form-label fw-bold">{{ form.segments_input.label }}</label>
                                    {% render_field form.segments_input class+="form-control" rows="5" %}
                                    {% if form.segments_input.help_text %}<div class="form-text">{{ form.segments_input.help_text|safe }}</div>{% endif %}
                                    <div class="form-text small bg-light p-2 rounded">
                                        <code>0:10-0:30 intro</code><br/><code>0:35-1:00 main_theme</code><br>
                                        <small class="text-muted">결과 파일명 접두사는 선택 사항입니다.</small>
                                    </div>
                                    <div class="invalid-feedback d-block" id="error-segments_input"></div>
                                </div>

                                <div class="row">
                                    <div class="col-md-8 mb-2">
                                        <label for="{{ form.tags_input.id_for_label }}" class="form-label">{{ form.tags_input.label }}</label>
                                        {% render_field form.tags_input class+="form-control" placeholder="예: 중요, 편집용, 발표자료" %}
                                        {% if form.tags_input.help_text %}<div class="form-text small">{{ form.tags_input.help_text|safe }}</div>{% endif %}
                                        <div class="invalid-feedback d-block" id="error-tags_input"></div>
                                    </div>
                                    <div class="col-md-4 mb-2">
                                        <div class="form-check mt-4 pt-2">
                                            {% render_field form.auto_start class+="form-check-input" %}
                                            <label for="{{ form.auto_start.id_for_label }}" class="form-check-label">
                                                {{ form.auto_start.label }}
                                            </label>
                                            {% if form.auto_start.help_text %}<div class="form-text small">{{ form.auto_start.help_text|safe }}</div>{% endif %}
                                            <div class="invalid-feedback d-block" id="error-auto_start"></div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-3">
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="fas fa-rocket me-2"></i>처리 시작
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
            
                    <div class="card mt-4">
                        <div class="card-header">
                            <h6 class="mb-0 fw-semibold d-flex align-items-center">
                                <i class="fas fa-chart-line me-2"></i>
                                {% if current_workspace %}
                                    {{ current_workspace.name }} 처리 개요 (실시간 업데이트)
                                {% else %}
                                    개인 작업 처리 개요 (실시간 업데이트)
                                {% endif %}
                            </h6>
                        </div>
                        <div class="card-body" id="processing-summary">
                            <p>현재 처리 중/대기 중인 작업: <span class="fw-bold"><i class="fas fa-spinner fa-spin"></i></span> 개</p>
                            <p>최근 24시간 내 완료된 작업: <span class="fw-bold"><i class="fas fa-spinner fa-spin"></i></span> 개</p>
                            <p class="mb-0">
                                <small class="text-muted">데이터를 불러오는 중...</small>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- 작업 목록 및 관리 탭 패널 -->
                <div class="tab-pane fade" id="manage-jobs-panel" role="tabpanel" aria-labelledby="manage-jobs-tab">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                            <h6 class="mb-0 fw-semibold d-flex align-items-center me-auto">
                                <i class="fas fa-tasks me-2"></i>내 모든 작업 목록 (<span id="total-jobs-count-display">{{ request.user.processing_jobs.count }}</span>개)
                            </h6>
                            <div class="btn-toolbar mt-2 mt-md-0" role="toolbar">
                                <form id="jobSearchForm" class="input-group input-group-sm me-2" role="search">
                                    <input type="search" id="jobSearchInput" class="form-control form-control-sm" placeholder="URL 또는 그룹명 검색..." aria-label="작업 검색">
                                    <button class="btn btn-outline-secondary" type="submit" title="검색"><i class="fas fa-search"></i></button>
                                </form>
                                <div class="input-group input-group-sm me-2">
                                    <label class="input-group-text visually-hidden" for="jobStatusFilter">상태</label>
                                    <select class="form-select form-select-sm" id="jobStatusFilter">
                                        <option value="">모든 상태</option>
                                        {% for code, display_name in job_status_choices %}
                                            <option value="{{ code }}" {% if code == current_status_filter %}selected{% endif %}>{{ display_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="input-group input-group-sm">
                                    <label class="input-group-text visually-hidden" for="jobSortBy">정렬</label>
                                    <select class="form-select form-select-sm" id="jobSortBy">
                                        <option value="-created_at" {% if current_sort_by == '-created_at' %}selected{% endif %}>최신순</option>
                                        <option value="created_at" {% if current_sort_by == 'created_at' %}selected{% endif %}>오래된순</option>
                                        <option value="status" {% if current_sort_by == 'status' %}selected{% endif %}>상태순</option>
                                        <option value="youtube_url" {% if current_sort_by == 'youtube_url' %}selected{% endif %}>URL순</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div id="tag-list-filter-container" class="mb-3">
                                <small class="text-muted me-2">태그 필터:</small>
                                <span id="tag-filter-pills">
                                    <span class="badge rounded-pill bg-light text-dark tag-filter-pill me-1 mb-1 {% if not current_tag_filter %}active{% endif %}" data-tag-name="">전체</span>
                                    {% for tag in available_tags %}
                                        <span class="badge rounded-pill bg-light text-dark tag-filter-pill me-1 mb-1 {% if tag.name == current_tag_filter %}active{% endif %}" data-tag-name="{{ tag.name }}">{{ tag.name }}</span>
                                    {% endfor %}
                                    {% if not available_tags %}<small class="text-muted fst-italic">사용된 태그가 없습니다.</small>{% endif %}
                                </span>
                                <!-- 태그 관리 버튼 (추후 구현) -->
                                {# <button class="btn btn-sm btn-outline-secondary ms-2" disabled title="태그 관리 (구현 예정)"><i class="fas fa-tags"></i></button> #}
                            </div>
                            <div id="job-list-container" class="mt-3">
                                <div class="text-center p-5 initial-load-spinner">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">작업 목록을 불러오는 중...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 인기 쇼츠 탭 패널 -->
                <div class="tab-pane fade" id="trending-shorts-panel" role="tabpanel" aria-labelledby="trending-shorts-tab">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center flex-wrap">
                            <h6 class="mb-0 fw-semibold d-flex align-items-center me-auto">
                                <i class="fab fa-youtube text-danger me-2"></i>YouTube 인기 쇼츠
                            </h6>
                            <div class="btn-toolbar mt-2 mt-md-0" role="toolbar">
                                <!-- 새로운 비교/즐겨찾기 페이지 링크 -->
                                <a href="{% url 'youtube_trending:shorts_comparison' %}" class="btn btn-sm btn-success me-2" title="쇼츠 비교 & 즐겨찾기">
                                    <i class="fas fa-chart-line me-1"></i>
                                    <i class="fas fa-heart ms-1"></i>
                                    비교/즐겨찾기
                                </a>
                                
                                <!-- 보기 방식 토글 -->
                                <div class="btn-group me-2" role="group" aria-label="보기 방식">
                                    <input type="radio" class="btn-check" name="viewMode" id="cardView" value="card">
                                    <label class="btn btn-outline-secondary btn-sm" for="cardView">
                                        <i class="fas fa-th-large"></i> 카드
                                    </label>
                                    <input type="radio" class="btn-check" name="viewMode" id="tableView" value="table" checked>
                                    <label class="btn btn-outline-secondary btn-sm" for="tableView">
                                        <i class="fas fa-list"></i> 표
                                    </label>
                                </div>
                                
                                <div class="input-group input-group-sm me-2">
                                    <label class="input-group-text visually-hidden" for="shortsCategory">카테고리</label>
                                    <select class="form-select form-select-sm" id="shortsCategory">
                                        <option value="all">모든 카테고리</option>
                                    </select>
                                </div>
                                <button class="btn btn-sm btn-primary" id="refreshShortsBtn">
                                    <i class="fas fa-sync-alt"></i> 새로고침
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <!-- 통계 요약 -->
                            <div class="p-3 bg-light border-bottom" id="shorts-stats-summary">
                                <div class="row align-items-center">
                                    <div class="col-3">
                                        <div class="fw-bold text-primary" id="total-shorts-count">-</div>
                                        <small class="text-muted">총 쇼츠</small>
                                    </div>
                                    <div class="col-6 text-center">
                                        <div class="d-flex align-items-center justify-content-center">
                                            <button class="btn btn-sm btn-outline-secondary me-2" id="prevDateBtn" title="이전 날짜">
                                                <i class="fas fa-chevron-left"></i>
                                            </button>
                                            <div class="fw-bold text-dark" id="current-date-display">오늘</div>
                                            <button class="btn btn-sm btn-outline-secondary ms-2" id="nextDateBtn" title="다음 날짜">
                                                <i class="fas fa-chevron-right"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-3 text-end">
                                        <div class="form-check form-switch d-inline-flex align-items-center">
                                            <input class="form-check-input me-2" type="checkbox" id="includeMusicSwitch">
                                            <label class="form-check-label fw-bold text-muted small" for="includeMusicSwitch">
                                                <i class="fas fa-music me-1"></i>음악/MV
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 쇼츠 목록 -->
                            <div id="trending-shorts-container" class="p-3">
                                <div class="text-center p-5" id="shorts-loading">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2">인기 쇼츠를 불러오는 중...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 태그 추출 탭 패널 -->
                <div class="tab-pane fade" id="tag-extractor-panel" role="tabpanel" aria-labelledby="tag-extractor-tab">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0 fw-semibold d-flex align-items-center">
                                <i class="fas fa-tags text-primary me-2"></i>YouTube 태그 추출
                                <span class="ms-auto text-muted small">해시 태그 추출기</span>
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="row g-4">
                                <!-- 좌측: URL 입력 및 비디오 정보 -->
                                <div class="col-lg-5">
                                    <form id="tag-extract-form">
                                        <div class="mb-3">
                                            <label for="tag-url-input" class="form-label fw-bold">YouTube URL</label>
                                            <div class="input-group">
                                                <input type="url" class="form-control" id="tag-url-input" 
                                                       placeholder="https://www.youtube.com/watch?v=..." required>
                                                <button class="btn btn-primary" type="submit" id="extract-tags-btn">
                                                    <i class="fas fa-search"></i> 추출
                                                </button>
                                            </div>
                                            <div class="form-text">YouTube 비디오, 쇼츠 URL을 입력하세요</div>
                                        </div>
                                    </form>
                                    
                                    <!-- 비디오 정보 -->
                                    <div id="video-info-section" style="display: none;">
                                        <h6 class="fw-bold">비디오 정보</h6>
                                        <div class="card bg-light">
                                            <div class="card-body p-3">
                                                <div id="video-thumbnail" class="text-center mb-3" style="display: none;">
                                                    <img id="video-thumb-img" src="" alt="썸네일" class="img-fluid rounded" style="max-height: 200px;">
                                                </div>
                                                <div id="video-title" class="fw-bold mb-2" style="font-size: 0.95rem;"></div>
                                                <div id="video-channel" class="text-muted mb-2">
                                                    <i class="fas fa-user-circle me-1"></i>
                                                    <span></span>
                                                </div>
                                                <div class="row text-muted small">
                                                    <div class="col-6">
                                                        <i class="fas fa-clock me-1"></i>
                                                        <span id="video-duration"></span>
                                                    </div>
                                                    <div class="col-6 text-end">
                                                        <i class="fas fa-eye me-1"></i>
                                                        <span id="video-views"></span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- 로딩 상태 -->
                                    <div id="tag-loading" class="text-center p-4" style="display: none;">
                                        <div class="spinner-border text-primary mb-2" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mb-0">태그를 추출하는 중...</p>
                                    </div>
                                    
                                    <!-- 에러 메시지 -->
                                    <div id="tag-error" class="alert alert-danger" style="display: none;"></div>
                                </div>
                                
                                <!-- 우측: 태그 목록 -->
                                <div class="col-lg-7">
                                    <div id="tag-results-container" style="display: none;">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6 class="fw-bold mb-0">추출된 태그</h6>
                                            <div class="d-flex align-items-center gap-2">
                                                <span class="badge bg-primary" id="tags-count">0</span>
                                                <button class="btn btn-sm btn-outline-primary" id="copy-all-tags-btn" title="모든 태그 복사">
                                                    <i class="fas fa-copy"></i> 전체 복사
                                                </button>
                                            </div>
                                        </div>
                                        <div id="tags-container" class="tags-list"></div>
                                    </div>
                                    
                                    <!-- 기본 상태 메시지 -->
                                    <div id="tag-default-message" class="text-center p-5 text-muted">
                                        <i class="fas fa-tags fa-3x mb-3 text-muted"></i>
                                        <h6>YouTube URL을 입력해주세요</h6>
                                        <p class="mb-0">비디오의 태그를 자동으로 추출해드립니다</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 새 그룹 만들기 모달 -->
<div class="modal fade" id="createGroupModal" tabindex="-1" aria-labelledby="createGroupModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="createGroupModalLabel">새 작업 그룹 만들기</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="createGroupForm" method="post" action="{% url 'video_processor:group_create' %}">
        {% csrf_token %}
        <div class="modal-body position-relative">
            <div class="loading-overlay d-none">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            <div id="create-group-form-messages" class="mb-3"></div>
            <div class="mb-3">
                <label for="{{ task_group_form.name.id_for_label }}" class="form-label">{{ task_group_form.name.label }}</label>
                {% render_field task_group_form.name class+="form-control" %}
                {% if task_group_form.name.help_text %}<div class="form-text">{{ task_group_form.name.help_text|safe }}</div>{% endif %}
                <div class="invalid-feedback d-block" id="error-name"></div>
            </div>
            <div class="mb-3">
                <label for="{{ task_group_form.description.id_for_label }}" class="form-label">{{ task_group_form.description.label }}</label>
                {% render_field task_group_form.description class+="form-control" rows="3" %}
                {% if task_group_form.description.help_text %}<div class="form-text">{{ task_group_form.description.help_text|safe }}</div>{% endif %}
                <div class="invalid-feedback d-block" id="error-description"></div>
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
          <button type="submit" class="btn btn-primary">그룹 생성</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Flatpickr JS -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ko.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
    // === 탭 상태 유지 기능 ===
    const tabLinks = document.querySelectorAll('button[data-bs-toggle="tab"]');
    const TAB_STORAGE_KEY = 'dashboard_active_tab';
    
    // 탭 변경 시 localStorage에 저장
    tabLinks.forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(event) {
            localStorage.setItem(TAB_STORAGE_KEY, event.target.id);
        });
    });
    
    // 페이지 로드 시 마지막 활성 탭 복원
    function restoreActiveTab() {
        const lastActiveTabId = localStorage.getItem(TAB_STORAGE_KEY);
        if (lastActiveTabId) {
            const lastActiveTab = document.getElementById(lastActiveTabId);
            if (lastActiveTab) {
                const tabInstance = new bootstrap.Tab(lastActiveTab);
                tabInstance.show();
            }
        }
    }
    
    // 초기 탭 복원 실행
    restoreActiveTab();
    
    // === 기존 코드 ===
    const jobListContainer = document.getElementById('job-list-container');
    let isLoadingJobs = false;
    let currentJobPage = 1;
    let hasMoreJobs = true;
    const jobStatusFilter = document.getElementById('jobStatusFilter');
    const totalJobsCountDisplay = document.getElementById('total-jobs-count-display');
    const jobSearchForm = document.getElementById('jobSearchForm');
    const jobSearchInput = document.getElementById('jobSearchInput');
    const jobSortBy = document.getElementById('jobSortBy');
    const tagFilterPillsContainer = document.getElementById('tag-filter-pills');
    let currentSelectedTag = ''; // 현재 선택된 태그
    const recentJobsListContainer = document.getElementById('recent-jobs-list-container');
    
    // URL 패턴을 위한 변수
    const jobStartUrlPattern = '/video-processor/job/{job_id}/start/';

    // --- 유틸리티 함수 ---
    function showAlert(containerId, message, type = 'danger') {
        const alertContainer = document.getElementById(containerId);
        if (!alertContainer) return;
        
        // type에서 'alert-' 접두사가 있다면 제거
        const cleanType = type.replace(/^alert-/, '');
        
        const alertHtml = `<div class="alert alert-${cleanType} alert-dismissible fade show" role="alert">
                            ${message}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>`;
        alertContainer.innerHTML = alertHtml;
    }

    function clearAlert(containerId) {
        const alertContainer = document.getElementById(containerId);
        if (alertContainer) alertContainer.innerHTML = '';
    }

    function setLoading(formElement, isLoading) {
        const overlay = formElement.closest('.position-relative')?.querySelector('.loading-overlay');
        if (overlay) {
            overlay.classList.toggle('d-none', !isLoading);
        }
        formElement.querySelectorAll('button[type="submit"]').forEach(button => button.disabled = isLoading);
    }
    
    function clearFormErrors(formElement) {
        formElement.querySelectorAll('.invalid-feedback').forEach(el => el.textContent = '');
        formElement.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
    }

    function displayFormErrors(formElement, errors) {
        clearFormErrors(formElement);
        for (const field in errors) {
            const errorElement = formElement.querySelector(`#error-${field}`);
            const fieldElement = formElement.querySelector(`[name="${field}"]`);
            if (errorElement) {
                errorElement.textContent = errors[field].join(', ');
            }
            if (fieldElement) {
                fieldElement.classList.add('is-invalid');
            }
        }
        if (errors.non_field_errors) {
            showAlert(formElement.id + '-messages', errors.non_field_errors.join(', '), 'danger');
        }
    }

    // --- 새 그룹 만들기 모달 처리 ---
    const createGroupForm = document.getElementById('createGroupForm');
    const createGroupModalEl = document.getElementById('createGroupModal');
    const createGroupModal = bootstrap.Modal.getOrCreateInstance(createGroupModalEl);

    if (createGroupForm) {
        createGroupForm.addEventListener('submit', function(event) {
            event.preventDefault();
            setLoading(createGroupForm, true);
            clearAlert('create-group-form-messages');
            clearFormErrors(createGroupForm);

            const formData = new FormData(createGroupForm);
            fetch(createGroupForm.action, {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('create-group-form-messages', '그룹이 성공적으로 생성되었습니다!', 'success');
                    
                    // 대시보드 전체 업데이트
                    fetchTaskGroups(); 
                    updateDashboard();
                    
                    setTimeout(() => {
                        createGroupModal.hide();
                        createGroupForm.reset();
                        clearAlert('create-group-form-messages');
                    }, 1500);
                } else if (data.errors) {
                    displayFormErrors(createGroupForm, data.errors);
                } else {
                    showAlert('create-group-form-messages', data.message || '그룹 생성에 실패했습니다.', 'danger');
                }
            })
            .catch(error => {
                console.error('Error creating group:', error);
                showAlert('create-group-form-messages', '그룹 생성 중 오류가 발생했습니다.', 'danger');
            })
            .finally(() => {
                setLoading(createGroupForm, false);
            });
        });
    }
    
    // 그룹 목록 동적 로드 및 업데이트 함수
    function fetchTaskGroups() {
        const container = document.getElementById('task-groups-list-container');
        if (!container) return;

        fetch("{% url 'video_processor:group_list' %}?partial=true", { // partial=true 쿼리 파라미터 추가
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.text()) // HTML을 텍스트로 받음
        .then(html => {
            container.innerHTML = html;
        })
        .catch(error => console.error('Error fetching task groups:', error));
    }


    // --- 작업 제출 폼 처리 ---
    const jobSubmitForm = document.getElementById('jobSubmitForm');
    if (jobSubmitForm) {
        // 전체 파일 다운로드 체크박스 이벤트 처리
        const downloadFullVideoCheckbox = document.getElementById('id_download_full_video');
        const segmentsInputContainer = document.getElementById('segments-input-container');
        const fullVideoPrefixContainer = document.getElementById('full-video-prefix-container');
        const segmentsInput = document.getElementById('id_segments_input');
        
        if (downloadFullVideoCheckbox && segmentsInputContainer && fullVideoPrefixContainer) {
            function toggleFields() {
                const isFullVideoChecked = downloadFullVideoCheckbox.checked;
                
                if (isFullVideoChecked) {
                    // 전체 파일 다운로드 체크 시
                    segmentsInputContainer.style.display = 'none';
                    fullVideoPrefixContainer.style.display = 'block';
                    segmentsInput.disabled = true;
                    segmentsInput.value = ''; // 세그먼트 입력 초기화
                } else {
                    // 전체 파일 다운로드 체크 해제 시
                    segmentsInputContainer.style.display = 'block';
                    fullVideoPrefixContainer.style.display = 'none';
                    segmentsInput.disabled = false;
                }
            }
            
            // 초기 상태 설정
            toggleFields();
            
            // 체크박스 변경 이벤트 리스너
            downloadFullVideoCheckbox.addEventListener('change', toggleFields);
        }
        
        jobSubmitForm.addEventListener('submit', function(event) {
            event.preventDefault();
            setLoading(jobSubmitForm, true);
            clearAlert('job-submit-form-messages');
            clearFormErrors(jobSubmitForm);

            const formData = new FormData(jobSubmitForm);
            fetch(jobSubmitForm.action, {
                method: 'POST',
                body: formData,
                headers: { 'X-CSRFToken': csrftoken, 'X-Requested-With': 'XMLHttpRequest' }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('job-submit-form-messages', data.message || '작업이 성공적으로 제출되었습니다!', 'success');
                    jobSubmitForm.reset();
                    
                    // 대시보드 전체 업데이트
                    updateDashboard();
                    
                } else if (data.errors) {
                    displayFormErrors(jobSubmitForm, data.errors);
                } else {
                    showAlert('job-submit-form-messages', data.message || '작업 제출에 실패했습니다.', 'danger');
                }
            })
            .catch(error => {
                console.error('Error submitting job:', error);
                showAlert('job-submit-form-messages', '작업 제출 중 오류가 발생했습니다.', 'danger');
            })
            .finally(() => {
                setLoading(jobSubmitForm, false);
            });
        });
    }

    // 최근 작업 목록 업데이트 함수
    function fetchRecentJobs(showSpinner = false) {
        if (!recentJobsListContainer) return;
        if (showSpinner) {
            recentJobsListContainer.innerHTML = '<div class="d-flex justify-content-center align-items-center p-3"><div class="spinner-border spinner-border-sm text-secondary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
        }
        
        fetch(`{% url 'video_processor:ajax_user_job_list' %}?recent=true&limit=5`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.text()) // HTML을 직접 받음
        .then(html => {
            recentJobsListContainer.innerHTML = html;
        })
        .catch(error => {
            console.error('Error fetching recent jobs:', error);
            recentJobsListContainer.innerHTML = '<p class="text-danger p-3">최근 작업 목록을 불러오는데 실패했습니다.</p>';
        });
    }
    
    function fetchProcessingSummary() {
        fetch(`{% url 'video_processor:ajax_processing_info' %}`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const processingSummaryContainer = document.getElementById('processing-summary');
                if (processingSummaryContainer) {
                    processingSummaryContainer.innerHTML = `
                        <p>현재 처리 중/대기 중인 작업: <span class="fw-bold text-primary">${data.processing_jobs_count}</span> 개</p>
                        <p>최근 24시간 내 완료된 작업: <span class="fw-bold text-success">${data.recent_completed_jobs_count}</span> 개</p>
                        <p class="mb-0">
                            <small class="text-muted">
                                실패한 작업: <span class="text-danger">${data.failed_jobs_count}</span>개 | 
                                전체 작업: <span class="text-info">${data.total_jobs_count}</span>개 |
                                마지막 업데이트: ${new Date().toLocaleTimeString()}
                            </small>
                        </p>
                    `;
                }
            }
        })
        .catch(error => {
            console.error('Error fetching processing summary:', error);
            const processingSummaryContainer = document.getElementById('processing-summary');
            if (processingSummaryContainer) {
                processingSummaryContainer.innerHTML = `
                    <p class="text-danger">처리 개요를 불러오는데 실패했습니다.</p>
                `;
            }
        });
    }

    // --- 작업 목록 관리 탭 기능 ---
    const manageJobsTab = document.getElementById('manage-jobs-tab');
    if (manageJobsTab) {
        manageJobsTab.addEventListener('shown.bs.tab', function (event) {
            if (jobListContainer.querySelector('.initial-load-spinner')) {
                loadJobs(1, true);
            }
        });
    }
    
    if (jobStatusFilter) {
        jobStatusFilter.addEventListener('change', function() {
            loadJobs(1, true); 
        });
    }

    if (jobSearchForm) {
        jobSearchForm.addEventListener('submit', function(event) {
            event.preventDefault();
            loadJobs(1, true);
        });
        // 검색창 내용이 비워졌을 때도 다시 로드 (옵션)
        jobSearchInput.addEventListener('search', function() {
            if (!jobSearchInput.value.trim()) {
                loadJobs(1, true);
            }
        });
    }

    if (jobSortBy) {
        jobSortBy.addEventListener("change", function() {
            loadJobs(1, true); // 정렬 변경 시 첫 페이지부터 새로 로드
        });
    }

    if (tagFilterPillsContainer) {
        tagFilterPillsContainer.addEventListener('click', function(event) {
            if (event.target.classList.contains('tag-filter-pill')) {
                tagFilterPillsContainer.querySelectorAll('.tag-filter-pill').forEach(pill => pill.classList.remove('active'));
                event.target.classList.add('active');
                currentSelectedTag = event.target.dataset.tagName;
                loadJobs(1, true); // 태그 필터 변경 시 첫 페이지부터 새로 로드
            }
        });
        // 초기 활성 태그 설정 (페이지 로드 시 URL 파라미터 등으로 설정된 경우 반영 위함)
        const initialActiveTagPill = tagFilterPillsContainer.querySelector('.tag-filter-pill.active');
        if (initialActiveTagPill) {
            currentSelectedTag = initialActiveTagPill.dataset.tagName;
        }
    }

    function loadJobs(page = 1, replaceCurrent = false) {
        if (isLoadingJobs || (!replaceCurrent && !hasMoreJobs && page > 1) ) return Promise.resolve();
        isLoadingJobs = true;
        currentJobPage = page;

        const spinner = jobListContainer.querySelector('.initial-load-spinner');
        const loadMoreButton = jobListContainer.querySelector('.load-more-jobs-btn');
        if (loadMoreButton) loadMoreButton.disabled = true;
        if (spinner && page === 1 && replaceCurrent) spinner.classList.remove('d-none');
        
        let queryParams = `?page=${page}`;
        const selectedStatus = jobStatusFilter ? jobStatusFilter.value : '';
        if (selectedStatus) queryParams += `&status=${selectedStatus}`;
        
        const searchQuery = jobSearchInput ? jobSearchInput.value.trim() : '';
        if (searchQuery) queryParams += `&search=${encodeURIComponent(searchQuery)}`;

        const sortBy = jobSortBy ? jobSortBy.value : '-created_at';
        if (sortBy) queryParams += `&sort_by=${sortBy}`;

        if (currentSelectedTag) { // 선택된 태그가 있으면 파라미터 추가
            queryParams += `&tag=${encodeURIComponent(currentSelectedTag)}`;
        }
        
        return fetch(`{% url 'video_processor:ajax_user_job_list' %}${queryParams}`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (spinner) spinner.classList.add('d-none');
                
                const jobCardsContainer = jobListContainer.querySelector('.job-cards-container');
                if (replaceCurrent || !jobCardsContainer) {
                    jobListContainer.innerHTML = data.html;
                } else {
                    if (loadMoreButton) loadMoreButton.parentElement.remove(); 
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = data.html;
                    const newCards = tempDiv.querySelector('.job-cards-container');
                    const newButtonContainer = tempDiv.querySelector('.load-more-jobs-btn')?.parentElement;

                    if (newCards) {
                        Array.from(newCards.children).forEach(cardCol => {
                            jobCardsContainer.appendChild(cardCol);
                        });
                    }
                    if (newButtonContainer) {
                        jobListContainer.appendChild(newButtonContainer);
                    }
                }
                hasMoreJobs = data.has_next;
                if (totalJobsCountDisplay && data.total_jobs !== undefined) { // total_jobs는 UserJobListView에서 전달 필요
                    totalJobsCountDisplay.textContent = data.total_jobs;
                }

                if (!hasMoreJobs && jobListContainer.querySelector('.load-more-jobs-btn')) {
                     const btn = jobListContainer.querySelector('.load-more-jobs-btn');
                     if(btn) btn.parentElement.innerHTML = '<p class="text-center text-muted mt-4"><small>모든 작업을 불러왔습니다.</small></p>';
                }
            } else {
                console.error("Error loading jobs:", data.error || data.message);
                if (page === 1) jobListContainer.innerHTML = `<p class="text-danger text-center">작업 목록을 불러오는데 실패했습니다: ${data.error || data.message || ''}</p>`;
            }
        })
        .catch(error => {
            console.error('Fetch error loading jobs:', error);
            if (page === 1) jobListContainer.innerHTML = '<p class="text-danger text-center">작업 목록 로드 중 오류 발생.</p>';
        })
        .finally(() => {
            isLoadingJobs = false;
            const newLoadMoreButton = jobListContainer.querySelector('.load-more-jobs-btn');
            if (newLoadMoreButton) newLoadMoreButton.disabled = false;
            // 초기 스피너가 여전히 있다면 (에러 등으로 인해 작업 목록이 로드되지 않은 경우) 숨김 처리
            if (spinner && !spinner.classList.contains('d-none') && !jobListContainer.querySelector('.job-cards-container')) {
                spinner.classList.add('d-none');
                if (!jobListContainer.textContent.trim()) { // 내용이 없으면 에러 메시지라도 표시
                     jobListContainer.innerHTML = '<p class="text-muted text-center">작업이 없거나 불러올 수 없습니다.</p>';
                }
            }
        });
    }

    // "더 보기" 버튼 이벤트 위임 (기존과 동일)
    jobListContainer.addEventListener('click', function(event) {
        if (event.target.classList.contains('load-more-jobs-btn')) {
            const nextPage = event.target.dataset.nextPage;
            if (nextPage) {
                loadJobs(parseInt(nextPage), false);
            }
        }
        
        // "시작" 버튼 클릭 이벤트 처리
        if (event.target.classList.contains('start-job-btn') || event.target.closest('.start-job-btn')) {
            const button = event.target.classList.contains('start-job-btn') ? event.target : event.target.closest('.start-job-btn');
            const jobId = button.dataset.jobId;
            
            if (!jobId) return;
            
            // 확인 대화상자
            if (!confirm('이 작업을 시작하시겠습니까?')) return;
            
            // 버튼 비활성화 및 로딩 상태 표시
            button.disabled = true;
            const originalContent = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 시작 중...';
            
            fetch(`${jobStartUrlPattern.replace('{job_id}', jobId)}`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 성공 시 즉시 상태 업데이트 및 애니메이션 시작
                    updateJobCardStatus(jobId, 'PROCESSING', '처리 중');
                    
                    // 버튼을 제거
                    button.remove();
                    
                    // 대시보드 업데이트
                    updateDashboard();
                    
                    showNotification(data.message, 'success');
                } else {
                    // 실패 시 버튼 복원
                    button.disabled = false;
                    button.innerHTML = originalContent;
                    showNotification(data.message || '작업 시작에 실패했습니다.', 'danger');
                }
            })
            .catch(error => {
                console.error('Error starting job:', error);
                // 에러 시 버튼 복원
                button.disabled = false;
                button.innerHTML = originalContent;
                showNotification('작업 시작 중 오류가 발생했습니다.', 'danger');
            });
        }
        
        // "재시도" 버튼 클릭 이벤트 처리
        if (event.target.classList.contains('retry-job-btn') || event.target.closest('.retry-job-btn')) {
            event.preventDefault();
            const button = event.target.classList.contains('retry-job-btn') ? event.target : event.target.closest('.retry-job-btn');
            const jobId = button.dataset.jobId;
            const jobTitle = button.dataset.jobTitle || '작업';
            
            if (!jobId) return;
            
            // 확인 대화상자
            if (!confirm(`'${jobTitle}' 작업을 재시도하시겠습니까?`)) return;
            
            // 버튼 비활성화 및 로딩 상태 표시
            button.disabled = true;
            const originalContent = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 재시도 중...';
            
            fetch(`/video-processor/job/${jobId}/retry/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (response.ok) {
                    // 재시도 성공 시 상태 업데이트
                    updateDashboard();
                    showNotification(`'${jobTitle}' 작업 재시도가 요청되었습니다.`, 'success');
                } else {
                    throw new Error('재시도 요청 실패');
                }
            })
            .catch(error => {
                console.error('Error retrying job:', error);
                // 에러 시 버튼 복원
                button.disabled = false;
                button.innerHTML = originalContent;
                showNotification('작업 재시도 중 오류가 발생했습니다.', 'danger');
            });
        }
        
        // "삭제" 버튼 클릭 이벤트 처리
        if (event.target.classList.contains('delete-job-btn') || event.target.closest('.delete-job-btn')) {
            event.preventDefault();
            const button = event.target.classList.contains('delete-job-btn') ? event.target : event.target.closest('.delete-job-btn');
            const jobId = button.dataset.jobId;
            const jobTitle = button.dataset.jobTitle || '작업';
            
            if (!jobId) return;
            
            // 확인 대화상자
            if (!confirm(`'${jobTitle}' 작업을 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.`)) return;
            
            // 버튼 비활성화 및 로딩 상태 표시
            button.disabled = true;
            const originalContent = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 삭제 중...';
            
            fetch(`/video-processor/job/${jobId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 성공 시 해당 작업 카드를 DOM에서 제거
                    const jobCard = button.closest('.col-md-6, .col-lg-4, .job-item, .card');
                    if (jobCard) {
                        jobCard.style.transition = 'all 0.3s ease';
                        jobCard.style.opacity = '0';
                        jobCard.style.transform = 'scale(0.9)';
                    setTimeout(() => {
                            jobCard.remove();
                            
                            // 작업 목록이 비어있는지 확인
                            const remainingCards = jobListContainer.querySelectorAll('.col-md-6, .col-lg-4, .job-item, .card');
                            if (remainingCards.length === 0 || (remainingCards.length === 1 && remainingCards[0].classList.contains('load-more-jobs-btn'))) {
                                // 현재 페이지를 새로고침하여 빈 상태 메시지 표시
                                loadJobs(currentJobPage, true);
                            }
                        }, 300);
                    }
                    
                    // 대시보드 전체 업데이트
                    updateDashboard();
                    showNotification(data.message, 'success');
                } else {
                    // 실패 시 버튼 복원
                    button.disabled = false;
                    button.innerHTML = originalContent;
                    showNotification(data.message || '작업 삭제에 실패했습니다.', 'danger');
                }
            })
            .catch(error => {
                console.error('Error deleting job:', error);
                // 에러 시 버튼 복원
                button.disabled = false;
                button.innerHTML = originalContent;
                showNotification('작업 삭제 중 오류가 발생했습니다.', 'danger');
            });
        }
    });
    
    // 최근 작업 목록에서도 삭제 버튼 이벤트 처리
    if (recentJobsListContainer) {
        recentJobsListContainer.addEventListener('click', function(event) {
            // "재시도" 버튼 클릭 이벤트 처리
            if (event.target.classList.contains('retry-job-btn') || event.target.closest('.retry-job-btn')) {
                event.preventDefault();
                const button = event.target.classList.contains('retry-job-btn') ? event.target : event.target.closest('.retry-job-btn');
                const jobId = button.dataset.jobId;
                const jobTitle = button.dataset.jobTitle || '작업';
                
                if (!jobId) return;
                
                // 확인 대화상자
                if (!confirm(`'${jobTitle}' 작업을 재시도하시겠습니까?`)) return;
                
                // 버튼 비활성화 및 로딩 상태 표시
                button.disabled = true;
                const originalContent = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 재시도 중...';
                
                fetch(`/video-processor/job/${jobId}/retry/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (response.ok) {
                        // 재시도 성공 시 상태 업데이트
                        updateDashboard();
                        showNotification(`'${jobTitle}' 작업 재시도가 요청되었습니다.`, 'success');
                    } else {
                        throw new Error('재시도 요청 실패');
                    }
                })
                .catch(error => {
                    console.error('Error retrying job:', error);
                    // 에러 시 버튼 복원
                    button.disabled = false;
                    button.innerHTML = originalContent;
                    showNotification('작업 재시도 중 오류가 발생했습니다.', 'danger');
                });
            }
            
            // "삭제" 버튼 클릭 이벤트 처리
            if (event.target.classList.contains('delete-job-btn') || event.target.closest('.delete-job-btn')) {
                event.preventDefault();
                const button = event.target.classList.contains('delete-job-btn') ? event.target : event.target.closest('.delete-job-btn');
                const jobId = button.dataset.jobId;
                const jobTitle = button.dataset.jobTitle || '작업';
                
                if (!jobId) return;
                
                // 확인 대화상자
                if (!confirm(`'${jobTitle}' 작업을 삭제하시겠습니까?\n\n이 작업은 되돌릴 수 없습니다.`)) return;
                
                // 버튼 비활성화 및 로딩 상태 표시
                button.disabled = true;
                const originalContent = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 삭제 중...';
                
                fetch(`/video-processor/job/${jobId}/delete/`, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 성공 시 해당 작업 항목을 DOM에서 제거
                        const listItem = button.closest('.list-group-item');
                        if (listItem) {
                            listItem.style.transition = 'all 0.3s ease';
                            listItem.style.opacity = '0';
                            listItem.style.transform = 'translateX(-100%)';
                    setTimeout(() => {
                                listItem.remove();
                                
                                // 목록이 비어있는지 확인
                                const remainingItems = recentJobsListContainer.querySelectorAll('.list-group-item');
                                if (remainingItems.length === 0) {
                                    recentJobsListContainer.innerHTML = '<p class="text-muted p-3">최근 제출된 작업이 없습니다.</p>';
                                }
                            }, 300);
                        }
                        
                        // 대시보드 전체 업데이트
                        updateDashboard();
                        showNotification(data.message, 'success');
                    } else {
                        // 실패 시 버튼 복원
                        button.disabled = false;
                        button.innerHTML = originalContent;
                        showNotification(data.message || '작업 삭제에 실패했습니다.', 'danger');
                }
            })
            .catch(error => {
                    console.error('Error deleting job:', error);
                // 에러 시 버튼 복원
                button.disabled = false;
                button.innerHTML = originalContent;
                    showNotification('작업 삭제 중 오류가 발생했습니다.', 'danger');
                });
            }
        });
    }
    
    // 알림 표시 함수
    function showNotification(message, type = 'info') {
        // type에서 'alert-' 접두사가 있다면 제거
        const cleanType = type.replace(/^alert-/, '');
        
                const alertContainer = document.createElement('div');
        alertContainer.className = `alert alert-${cleanType} alert-dismissible fade show position-fixed`;
        alertContainer.style.cssText = 'top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; max-width: 400px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
                alertContainer.innerHTML = `
            ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                `;
                document.body.appendChild(alertContainer);
                
        // 자동 제거 (성공: 3초, 에러: 5초)
        const timeout = cleanType === 'success' ? 3000 : 5000;
                setTimeout(() => {
                    if (alertContainer.parentNode) {
                        alertContainer.remove();
                    }
        }, timeout);
    }
    
    // 진행상태 애니메이션 관련 함수들
    const progressAnimations = new Map(); // 작업 ID별 애니메이션 추적
    
    function startProgressAnimation(jobId, duration = 30000) {
        // 기존 애니메이션이 있으면 중지
        if (progressAnimations.has(jobId)) {
            clearInterval(progressAnimations.get(jobId));
        }
        
        const jobCard = document.querySelector(`[data-job-id="${jobId}"]`);
        if (!jobCard) return;
        
        const progressContainer = jobCard.querySelector('.job-progress-container');
        const progressBar = jobCard.querySelector('.job-progress-bar');
        const progressPercentage = jobCard.querySelector('.job-progress-percentage');
        
        if (!progressContainer || !progressBar || !progressPercentage) return;
        
        // 진행 컨테이너 표시
        progressContainer.style.display = 'block';
        
        let progress = 0;
        const increment = 1; // 1%씩 증가
        const interval = duration / 95; // 95%까지만 진행 (완료는 별도 처리)
        
        const animationInterval = setInterval(() => {
            progress += increment;
            if (progress >= 95) {
                progress = 95; // 95%에서 멈춤
                clearInterval(animationInterval);
                progressAnimations.delete(jobId);
            }
            
            progressBar.style.width = `${progress}%`;
            progressBar.setAttribute('aria-valuenow', progress);
            progressPercentage.textContent = `${Math.round(progress)}%`;
        }, interval);
        
        progressAnimations.set(jobId, animationInterval);
    }
    
    function completeProgressAnimation(jobId) {
        // 기존 애니메이션 중지
        if (progressAnimations.has(jobId)) {
            clearInterval(progressAnimations.get(jobId));
            progressAnimations.delete(jobId);
        }
        
        const jobCard = document.querySelector(`[data-job-id="${jobId}"]`);
        if (!jobCard) return;
        
        const progressContainer = jobCard.querySelector('.job-progress-container');
        const progressBar = jobCard.querySelector('.job-progress-bar');
        const progressPercentage = jobCard.querySelector('.job-progress-percentage');
        const completionContainer = jobCard.querySelector('.job-completion-container');
        
        if (!progressBar || !progressPercentage) return;
        
        // 빠르게 100%로 완성
        progressBar.style.width = '100%';
        progressBar.setAttribute('aria-valuenow', 100);
        progressPercentage.textContent = '100%';
        
        // 1초 후 완료 상태로 전환
        setTimeout(() => {
            if (progressContainer) progressContainer.style.display = 'none';
            if (completionContainer) completionContainer.style.display = 'block';
        }, 1000);
    }
    
    function updateJobCardStatus(jobId, newStatus, newStatusDisplay) {
        const jobCard = document.querySelector(`[data-job-id="${jobId}"]`);
        if (!jobCard) return;
        
        // 작업 카드의 상태 업데이트
        jobCard.setAttribute('data-job-status', newStatus);
        
        // 상태 배지 업데이트
        const statusBadge = jobCard.querySelector('.job-status-badge');
        if (statusBadge) {
            statusBadge.textContent = newStatusDisplay;
            statusBadge.className = 'badge float-end job-status-badge';
            
            if (newStatus === 'COMPLETED') {
                statusBadge.classList.add('bg-success');
            } else if (newStatus === 'PROCESSING' || newStatus === 'DOWNLOADING') {
                statusBadge.classList.add('bg-primary');
            } else if (newStatus === 'PENDING') {
                statusBadge.classList.add('bg-secondary');
            } else if (newStatus === 'FAILED') {
                statusBadge.classList.add('bg-danger');
            } else {
                statusBadge.classList.add('bg-dark');
            }
        }
        
        // 진행상태에 따른 애니메이션 처리
        if (newStatus === 'PROCESSING' || newStatus === 'DOWNLOADING') {
            startProgressAnimation(jobId);
        } else if (newStatus === 'COMPLETED') {
            completeProgressAnimation(jobId);
        } else {
            // 기타 상태에서는 진행 바 숨김
            const progressContainer = jobCard.querySelector('.job-progress-container');
            const completionContainer = jobCard.querySelector('.job-completion-container');
            if (progressContainer) progressContainer.style.display = 'none';
            if (completionContainer) completionContainer.style.display = 'none';
            
            // 애니메이션 중지
            if (progressAnimations.has(jobId)) {
                clearInterval(progressAnimations.get(jobId));
                progressAnimations.delete(jobId);
            }
        }
    }
    
    // 기존 updateDashboard 함수 수정
    function updateDashboard() {
        // 현재 표시된 작업들의 상태와 진행상태 저장
        const currentJobStates = new Map();
        const currentProgressStates = new Map();
        
        document.querySelectorAll('[data-job-id]').forEach(card => {
            const jobId = card.getAttribute('data-job-id');
            const status = card.getAttribute('data-job-status');
            currentJobStates.set(jobId, status);
            
            // 현재 진행상태도 저장
            const progressBar = card.querySelector('.job-progress-bar');
            const progressPercentage = card.querySelector('.job-progress-percentage');
            if (progressBar && progressPercentage) {
                const currentProgress = parseInt(progressBar.getAttribute('aria-valuenow')) || 0;
                currentProgressStates.set(jobId, currentProgress);
            }
        });
        
        // 처리 개요 업데이트
        fetchProcessingSummary();
        // 최근 작업 목록 업데이트
        fetchRecentJobs(true);
        // 작업 목록 업데이트 (현재 페이지)
        loadJobs(currentJobPage, true).then(() => {
            // 상태 변경 감지 및 애니메이션 적용
            document.querySelectorAll('[data-job-id]').forEach(card => {
                const jobId = card.getAttribute('data-job-id');
                const newStatus = card.getAttribute('data-job-status');
                const oldStatus = currentJobStates.get(jobId);
                const savedProgress = currentProgressStates.get(jobId) || 0;
                
                if (oldStatus && oldStatus !== newStatus) {
                    // 상태가 변경된 경우
                    const statusBadge = card.querySelector('.job-status-badge');
                    const statusDisplay = statusBadge ? statusBadge.textContent : '';
                    
                    updateJobCardStatus(jobId, newStatus, statusDisplay);
                } else if ((newStatus === 'PROCESSING' || newStatus === 'DOWNLOADING') && oldStatus === newStatus) {
                    // 같은 처리 상태가 유지되는 경우 - 진행상태 복원
                    if (!progressAnimations.has(jobId)) {
                        // 애니메이션이 없으면 새로 시작하되, 저장된 진행상태부터 시작
                        startProgressAnimationFromProgress(jobId, savedProgress);
                    }
                } else if (newStatus === 'PROCESSING' || newStatus === 'DOWNLOADING') {
                    // 새로 추가된 작업이 처리 중인 경우
                    if (!progressAnimations.has(jobId)) {
                        startProgressAnimation(jobId);
                    }
                }
            });
        });
    }
    
    function startProgressAnimationFromProgress(jobId, startProgress = 0, duration = 30000) {
        // 기존 애니메이션이 있으면 중지
        if (progressAnimations.has(jobId)) {
            clearInterval(progressAnimations.get(jobId));
        }
        
        const jobCard = document.querySelector(`[data-job-id="${jobId}"]`);
        if (!jobCard) return;
        
        const progressContainer = jobCard.querySelector('.job-progress-container');
        const progressBar = jobCard.querySelector('.job-progress-bar');
        const progressPercentage = jobCard.querySelector('.job-progress-percentage');
        
        if (!progressContainer || !progressBar || !progressPercentage) return;
        
        // 진행 컨테이너 표시
        progressContainer.style.display = 'block';
        
        // 시작 진행률 설정
        let progress = Math.min(startProgress, 95); // 95% 이상은 95%로 제한
        progressBar.style.width = `${progress}%`;
        progressBar.setAttribute('aria-valuenow', progress);
        progressPercentage.textContent = `${Math.round(progress)}%`;
        
        if (progress >= 95) {
            // 이미 95% 이상이면 애니메이션 중단
            return;
        }
        
        const increment = 1; // 1%씩 증가
        const remainingProgress = 95 - progress;
        const interval = duration / remainingProgress; // 남은 시간에 따라 간격 조정
        
        const animationInterval = setInterval(() => {
            progress += increment;
            if (progress >= 95) {
                progress = 95; // 95%에서 멈춤
                clearInterval(animationInterval);
                progressAnimations.delete(jobId);
            }
            
            progressBar.style.width = `${progress}%`;
            progressBar.setAttribute('aria-valuenow', progress);
            progressPercentage.textContent = `${Math.round(progress)}%`;
        }, interval);
        
        progressAnimations.set(jobId, animationInterval);
    }

    // 초기 데이터 로드 (기존)
    fetchProcessingSummary();
    // fetchTaskGroups(); // 대시보드 로드 시 그룹 목록은 이미 context로 전달받으므로 초기 AJAX 호출 불필요. 생성/삭제 시에만 호출.

    // 이미 로드된 작업들 중 처리 중인 것들에 대해 애니메이션 시작
    document.querySelectorAll('[data-job-status="PROCESSING"], [data-job-status="DOWNLOADING"]').forEach(card => {
        const jobId = card.getAttribute('data-job-id');
        if (jobId && !progressAnimations.has(jobId)) {
            startProgressAnimation(jobId);
        }
    });

    // 10초마다 처리 개요 업데이트
    setInterval(fetchProcessingSummary, 10000);
    
    // 60초마다 최근 작업 목록 업데이트 (너무 자주 하지 않도록 30초에서 60초로 변경)
    setInterval(() => {
        fetchRecentJobs(false); // 스피너 없이 업데이트
    }, 60000);
    
    // 45초마다 작업 목록 상태 체크 (새로운 간격 추가)
    setInterval(() => {
        if (document.querySelector('#manage-jobs-panel.active')) {
            // 작업 관리 탭이 활성화된 경우에만 목록 갱신
            loadJobs(currentJobPage, true);
        }
    }, 45000);

    // 진행 중인 작업이 있는지 확인하고 더 자주 업데이트하는 함수
    function hasProcessingJobs() {
        return document.querySelectorAll('[data-job-status="PROCESSING"], [data-job-status="DOWNLOADING"]').length > 0;
    }
    
    // 조건부 빠른 업데이트 (진행 중인 작업이 있을 때만)
    setInterval(() => {
        if (hasProcessingJobs()) {
            // 진행 중인 작업이 있으면 더 자주 상태 확인
            fetchProcessingSummary();
            
            // 15초마다 한 번씩 상태만 확인 (전체 갱신은 아님)
            if (Math.random() < 0.3) { // 30% 확률로만 전체 갱신
                updateDashboard();
            }
        }
    }, 15000);
    
    // 기존 간격 유지
    // 10초마다 처리 개요 업데이트

    // === 인기 쇼츠 기능 ===
    const trendingShortsTab = document.getElementById('trending-shorts-tab');
    const shortsContainer = document.getElementById('trending-shorts-container');
    const shortsLoading = document.getElementById('shorts-loading');
    const shortsCategory = document.getElementById('shortsCategory');
    const shortsDays = document.getElementById('shortsDays');
    const refreshShortsBtn = document.getElementById('refreshShortsBtn');
    const includeMusicSwitch = document.getElementById('includeMusicSwitch');
    const cardViewBtn = document.getElementById('cardView');
    const tableViewBtn = document.getElementById('tableView');
    
    // 날짜 변경 버튼들
    const prevDateBtn = document.getElementById('prevDateBtn');
    const nextDateBtn = document.getElementById('nextDateBtn');
    const currentDateDisplay = document.getElementById('current-date-display');
    
    let currentShortsPage = 1;
    let isLoadingShorts = false;
    let hasMoreShorts = true;
    let currentViewMode = 'table'; // 기본값을 table로 변경
    let currentDays = 1; // 현재 선택된 날짜 범위
    let currentDate = new Date(); // 현재 선택된 날짜
    let flatpickrInstance = null; // Flatpickr 인스턴스
    
    // 카테고리별 컬러 매핑 (실제 DB 키 값 기준)
    const categoryColors = {
        'entertainment': 'entertainment',
        'music': 'music', 
        'gaming': 'gaming',
        'sports': 'sports',
        'news': 'news',
        'education': 'education',
        'tech': 'tech',
        'comedy': 'comedy',
        'lifestyle': 'lifestyle',
        'other': 'other'
    };
    
    // 카테고리 한글명을 영어 키로 변환하는 매핑
    const categoryKeyMapping = {
        '엔터테인먼트': 'entertainment',
        '음악': 'music',
        '게임': 'gaming', 
        '스포츠': 'sports',
        '뉴스': 'news',
        '교육': 'education',
        '과학 기술': 'tech',
        '코미디': 'comedy',
        '라이프스타일': 'lifestyle',
        '기타': 'other'
    };
    
    // 날짜 포맷 함수
    function formatDate(date) {
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        
        if (date.toDateString() === today.toDateString()) {
            return '오늘';
        } else if (date.toDateString() === yesterday.toDateString()) {
            return '어제';
        } else {
            return date.toLocaleDateString('ko-KR', {
                month: 'long',
                day: 'numeric'
            });
        }
    }
    
    // 날짜 표시 업데이트
    function updateDateDisplay() {
        if (currentDateDisplay) {
            currentDateDisplay.textContent = formatDate(currentDate);
            currentDateDisplay.style.cursor = 'pointer';
            currentDateDisplay.title = '클릭하여 날짜 선택';
        }
        
        // 다음 버튼 비활성화 (오늘이 최대)
        const today = new Date();
        if (nextDateBtn) {
            nextDateBtn.disabled = currentDate.toDateString() === today.toDateString();
        }
    }
    
    // Flatpickr 초기화
    function initializeDatePicker() {
        if (currentDateDisplay && !flatpickrInstance) {
            flatpickrInstance = flatpickr(currentDateDisplay, {
                locale: 'ko',
                dateFormat: 'Y-m-d',
                defaultDate: currentDate,
                maxDate: 'today',
                onChange: function(selectedDates, dateStr, instance) {
                    if (selectedDates.length > 0) {
                        currentDate = selectedDates[0];
                        updateDateDisplay();
                        loadTrendingShorts(true);
                        loadShortsCategories();
                        loadShortsStats();
                    }
                },
                onClose: function(selectedDates, dateStr, instance) {
                    // 포커스 제거하여 깔끔하게 보이게 함
                    instance.input.blur();
                }
            });
        }
    }
    
    // 인기 쇼츠 탭 활성화 시 데이터 로드
    if (trendingShortsTab) {
        trendingShortsTab.addEventListener('shown.bs.tab', function (event) {
            if (!shortsContainer.querySelector('.shorts-grid') && !shortsContainer.querySelector('.table-responsive')) {
                initializeDatePicker();
                updateDateDisplay();
                loadTrendingShorts(true);
                loadShortsCategories();
                loadShortsStats();
            }
        });
    }
    
    // 보기 방식 변경 이벤트
    if (cardViewBtn && tableViewBtn) {
        cardViewBtn.addEventListener('change', function() {
            if (this.checked) {
                currentViewMode = 'card';
                loadTrendingShorts(true);
            }
        });
        
        tableViewBtn.addEventListener('change', function() {
            if (this.checked) {
                currentViewMode = 'table';
                loadTrendingShorts(true);
            }
        });
    }
    
    // 필터 변경 이벤트
    if (shortsCategory) {
        shortsCategory.addEventListener('change', function() {
            loadTrendingShorts(true);
        });
    }
    
    if (shortsDays) {
        shortsDays.addEventListener('change', function() {
            loadTrendingShorts(true);
            loadShortsCategories();
            loadShortsStats();
        });
    }
    
    // 음악 필터 변경 이벤트
    if (includeMusicSwitch) {
        includeMusicSwitch.addEventListener('change', function() {
            loadTrendingShorts(true);
            loadShortsCategories();
            loadShortsStats();
        });
    }
    
    // 새로고침 버튼
    if (refreshShortsBtn) {
        refreshShortsBtn.addEventListener('click', function() {
            loadTrendingShorts(true);
            loadShortsCategories();
            loadShortsStats();
        });
    }
    
    // 카테고리 목록 로드
    function loadShortsCategories() {
        const dateStr = currentDate.toISOString().split('T')[0];
        const includeMusic = includeMusicSwitch ? includeMusicSwitch.checked : false;
        
        fetch(`/trending/api/categories/?date=${dateStr}&include_music=${includeMusic}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && shortsCategory) {
                const currentValue = shortsCategory.value;
                
                // 기존 옵션들을 완전히 제거 (개선된 방법)
                shortsCategory.innerHTML = '';
                
                // 중복 제거를 위한 Set 사용
                const seenValues = new Set();
                
                data.categories.forEach(category => {
                    if (!seenValues.has(category.value)) {
                        seenValues.add(category.value);
                        const option = document.createElement('option');
                        option.value = category.value;
                        option.textContent = category.label;
                        if (category.value === currentValue) {
                            option.selected = true;
                        }
                        shortsCategory.appendChild(option);
                    }
                });
            }
        })
        .catch(error => {
            console.error('카테고리 로드 오류:', error);
        });
    }
    
    // 통계 로드
    function loadShortsStats() {
        // 현재 선택된 날짜를 YYYY-MM-DD 형식으로 변환
        const dateStr = currentDate.toISOString().split('T')[0];
        
        fetch(`/trending/api/stats/?date=${dateStr}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const stats = data.stats;
                
                document.getElementById('total-shorts-count').textContent = stats.total_shorts_collected || 0;
            }
        })
        .catch(error => {
            console.error('통계 로드 오류:', error);
        });
    }
    
    // 인기 쇼츠 데이터 로드
    function loadTrendingShorts(reset = false) {
        if (isLoadingShorts) return;
        
        isLoadingShorts = true;
        
        if (reset) {
            currentShortsPage = 1;
            hasMoreShorts = true;
        }
        
        const category = shortsCategory ? shortsCategory.value : 'all';
        // 현재 선택된 날짜를 YYYY-MM-DD 형식으로 변환
        const dateStr = currentDate.toISOString().split('T')[0];
        const includeMusic = includeMusicSwitch ? includeMusicSwitch.checked : false;
        const params = new URLSearchParams({
            page: currentShortsPage,
            category: category,
            date: dateStr,
            include_music: includeMusic,
            limit: 20
        });
        
        // 로딩 상태 표시
        if (reset) {
            shortsContainer.innerHTML = '<div class="text-center p-3"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
        } else {
            // 더보기 버튼 비활성화
            const loadMoreBtn = document.getElementById('load-more-shorts');
            if (loadMoreBtn) {
                loadMoreBtn.disabled = true;
                loadMoreBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>로딩중...';
            }
        }
        
        fetch(`/trending/api/shorts/?${params}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (reset) {
                    if (currentViewMode === 'table') {
                        displayShortsTable(data.shorts, data.pagination);
                    } else {
                        displayShorts(data.shorts, data.pagination);
                    }
                } else {
                    if (currentViewMode === 'table') {
                        appendShortsTable(data.shorts, data.pagination);
                    } else {
                        appendShorts(data.shorts, data.pagination);
                    }
                }
            } else {
                throw new Error(data.error || '데이터 로드 실패');
            }
        })
        .catch(error => {
            console.error('쇼츠 로드 오류:', error);
            if (reset) {
                shortsContainer.innerHTML = `
                    <div class="shorts-empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h6>데이터를 불러올 수 없습니다</h6>
                        <p>오류가 발생했습니다: ${error.message}</p>
                        <button class="btn btn-primary btn-sm" onclick="loadTrendingShorts(true)">다시 시도</button>
                    </div>
                `;
            }
        })
        .finally(() => {
            isLoadingShorts = false;
        });
    }
    
    // 카드 형태로 쇼츠 표시
    function displayShorts(shorts, pagination) {
        if (!shorts || shorts.length === 0) {
            shortsContainer.innerHTML = `
                <div class="shorts-empty-state">
                    <i class="fab fa-youtube"></i>
                    <h6>인기 쇼츠가 없습니다</h6>
                    <p>선택한 조건에 맞는 쇼츠가 없습니다.</p>
                </div>
            `;
            return;
        }
        
        const shortsGrid = createShortsGrid(shorts);
        const loadMoreButton = createLoadMoreButton(pagination);
        
        shortsContainer.innerHTML = '';
        shortsContainer.appendChild(shortsGrid);
        if (pagination.has_next) {
            shortsContainer.appendChild(loadMoreButton);
        }
        
        hasMoreShorts = pagination.has_next;
    }
    
    // 테이블 형태로 쇼츠 표시
    function displayShortsTable(shorts, pagination) {
        if (!shorts || shorts.length === 0) {
            shortsContainer.innerHTML = `
                <div class="shorts-empty-state">
                    <i class="fab fa-youtube"></i>
                    <h6>인기 쇼츠가 없습니다</h6>
                    <p>선택한 조건에 맞는 쇼츠가 없습니다.</p>
                </div>
            `;
            return;
        }
        
        const tableContainer = createShortsTable(shorts);
        const loadMoreButton = createLoadMoreButton(pagination);
        
        shortsContainer.innerHTML = '';
        shortsContainer.appendChild(tableContainer);
        if (pagination.has_next) {
            shortsContainer.appendChild(loadMoreButton);
        }
        
        hasMoreShorts = pagination.has_next;
    }
    
    // 쇼츠 추가 (카드)
    function appendShorts(shorts, pagination) {
        const existingGrid = shortsContainer.querySelector('.shorts-grid');
        const existingLoadMore = document.getElementById('load-more-shorts');
        
        if (existingLoadMore) {
            existingLoadMore.remove();
        }
        
        if (existingGrid && shorts.length > 0) {
            shorts.forEach(short => {
                const shortCard = createShortCard(short);
                existingGrid.appendChild(shortCard);
            });
        }
        
        if (pagination.has_next) {
            const loadMoreButton = createLoadMoreButton(pagination);
            shortsContainer.appendChild(loadMoreButton);
        }
        
        hasMoreShorts = pagination.has_next;
    }
    
    // 쇼츠 추가 (테이블)
    function appendShortsTable(shorts, pagination) {
        const existingTable = shortsContainer.querySelector('.shorts-table tbody');
        const existingLoadMore = document.getElementById('load-more-shorts');
        
        if (existingLoadMore) {
            existingLoadMore.remove();
        }
        
        if (existingTable && shorts.length > 0) {
            shorts.forEach(short => {
                const shortRow = createShortTableRow(short);
                existingTable.appendChild(shortRow);
            });
        }
        
        if (pagination.has_next) {
            const loadMoreButton = createLoadMoreButton(pagination);
            shortsContainer.appendChild(loadMoreButton);
        }
        
        hasMoreShorts = pagination.has_next;
    }
    
    // 쇼츠 그리드 생성
    function createShortsGrid(shorts) {
        const grid = document.createElement('div');
        grid.className = 'shorts-grid';
        
        shorts.forEach(short => {
            const shortCard = createShortCard(short);
            grid.appendChild(shortCard);
        });
        
        return grid;
    }
    
    // 쇼츠 테이블 생성
    function createShortsTable(shorts) {
        const tableContainer = document.createElement('div');
        tableContainer.className = 'table-responsive';
        
        const table = document.createElement('table');
        table.className = 'table shorts-table';
        
        // 헤더 생성
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        
        const headers = [
            { text: '순위', class: 'rank-cell' },
            { text: '썸네일', class: 'thumbnail-cell' },
            { text: '제목/채널', class: 'title-cell' },
            { text: '조회수', class: 'views-cell' },
            { text: '좋아요', class: 'likes-cell' },
            { text: '댓글', class: 'comments-cell' },
            { text: '카테고리', class: 'category-cell' },
            { text: '영상길이', class: 'duration-cell' }
        ];
        
        headers.forEach(header => {
            const th = document.createElement('th');
            th.textContent = header.text;
            th.className = header.class;
            headerRow.appendChild(th);
        });
        
        thead.appendChild(headerRow);
        table.appendChild(thead);
        
        // 바디 생성
        const tbody = document.createElement('tbody');
        
        shorts.forEach(short => {
            const row = createShortTableRow(short);
            tbody.appendChild(row);
        });
        
        table.appendChild(tbody);
        tableContainer.appendChild(table);
        
        return tableContainer;
    }
    
    // 개별 쇼츠 카드 생성 (순위 변동 추가)
    function createShortCard(short) {
        const card = document.createElement('div');
        card.className = 'shorts-card';
        
        // 썸네일 기본값 처리
        const thumbnailUrl = short.thumbnail_url || '/static/images/no-thumbnail.jpg';
        
        // 순위 변동 표시
        let rankChangeHtml = '';
        if (short.is_new) {
            rankChangeHtml = '<span class="new-badge">NEW</span>';
        } else if (short.rank_change !== null && short.rank_change !== undefined) {
            if (short.rank_change > 0) {
                rankChangeHtml = `<span class="rank-change up">${short.rank_change}</span>`;
            } else if (short.rank_change < 0) {
                rankChangeHtml = `<span class="rank-change down">${Math.abs(short.rank_change)}</span>`;
            } else {
                rankChangeHtml = '<span class="rank-change same">0</span>';
            }
        }
        
        // 카테고리 컬러 클래스 결정
        const categoryKey = categoryKeyMapping[short.category] || short.category;
        const categoryClass = categoryColors[categoryKey] || 'other';
        
        card.innerHTML = `
            <div class="shorts-thumbnail">
                <img src="${thumbnailUrl}" alt="${short.title}" loading="lazy" class="shorts-thumbnail"
                     onerror="this.src='/static/images/no-thumbnail.jpg'">
                <div class="shorts-rank-badge">#${short.trending_rank}${rankChangeHtml}</div>
                <div class="shorts-duration">${short.duration}</div>
            </div>
            <div class="shorts-info">
                <div class="shorts-title" title="${short.title}">${short.title}</div>
                <div class="shorts-channel">${short.channel_title}</div>
                <div class="shorts-stats">
                    <span class="shorts-views">${short.formatted_view_count} 조회</span>
                    <span class="shorts-likes">❤️ ${formatNumber(short.like_count || 0)}</span>
                    <span class="shorts-comments">💬 ${formatNumber(short.comment_count || 0)}</span>
                </div>
                <div class="mt-2">
                    <span class="category-badge ${categoryClass}">${short.category}</span>
                </div>
            </div>
        `;
        
        // 클릭 시 YouTube에서 열기
        card.addEventListener('click', function() {
            window.open(short.youtube_url, '_blank');
        });
        
        card.style.cursor = 'pointer';
        
        return card;
    }
    
    // 테이블 행 생성
    function createShortTableRow(short) {
        const row = document.createElement('tr');
        
        // 썸네일 기본값 처리
        const thumbnailUrl = short.thumbnail_url || '/static/images/no-thumbnail.jpg';
        
        // 순위 변동 표시
        let rankChangeHtml = '';
        if (short.is_new) {
            rankChangeHtml = '<span class="new-badge">NEW</span>';
        } else if (short.rank_change !== null && short.rank_change !== undefined) {
            if (short.rank_change > 0) {
                rankChangeHtml = `<span class="rank-change up">${short.rank_change}</span>`;
            } else if (short.rank_change < 0) {
                rankChangeHtml = `<span class="rank-change down">${Math.abs(short.rank_change)}</span>`;
            } else {
                rankChangeHtml = '<span class="rank-change same">0</span>';
            }
        }
        
        // 카테고리 컬러 클래스 결정
        const categoryKey = categoryKeyMapping[short.category] || short.category;
        const categoryClass = categoryColors[categoryKey] || 'other';
        
        row.innerHTML = `
            <td class="rank-cell">
                <strong>${short.trending_rank}</strong>
                ${rankChangeHtml}
            </td>
            <td class="thumbnail-cell">
                <img src="${thumbnailUrl}" alt="썸네일" class="thumbnail-small" 
                     onerror="this.src='/static/images/no-thumbnail.jpg'">
            </td>
            <td class="title-cell">
                <div class="title-text" title="${short.title}">${short.title}</div>
                <div class="channel-text">${short.channel_title}</div>
            </td>
            <td class="views-cell">${short.formatted_view_count}</td>
            <td class="likes-cell">${formatNumber(short.like_count || 0)}</td>
            <td class="comments-cell">${formatNumber(short.comment_count || 0)}</td>
            <td class="category-cell">
                <span class="category-badge ${categoryClass}">${short.category}</span>
            </td>
            <td class="duration-cell">${short.duration}</td>
        `;
        
        // 클릭 시 YouTube에서 열기
        row.addEventListener('click', function() {
            window.open(short.youtube_url, '_blank');
        });
        
        row.style.cursor = 'pointer';
        
        return row;
    }
    
    // 더보기 버튼 생성
    function createLoadMoreButton(pagination) {
        const container = document.createElement('div');
        container.className = 'shorts-load-more';
        
        const button = document.createElement('button');
        button.id = 'load-more-shorts';
        button.className = 'btn btn-outline-primary';
        button.textContent = '더보기';
        
        button.addEventListener('click', function() {
            currentShortsPage++;
            loadTrendingShorts(false);
        });
        
        container.appendChild(button);
        return container;
    }

    // 날짜 변경 버튼 이벤트
    if (prevDateBtn) {
        prevDateBtn.addEventListener('click', function() {
            const newDate = new Date(currentDate);
            newDate.setDate(newDate.getDate() - 1);
            currentDate = newDate;
            
            updateDateDisplay();
            loadTrendingShorts(true);
            loadShortsCategories();
            loadShortsStats();
        });
    }
    
    if (nextDateBtn) {
        nextDateBtn.addEventListener('click', function() {
            const today = new Date();
            if (currentDate.toDateString() !== today.toDateString()) {
                const newDate = new Date(currentDate);
                newDate.setDate(newDate.getDate() + 1);
                currentDate = newDate;
                
                updateDateDisplay();
                loadTrendingShorts(true);
                loadShortsCategories();
                loadShortsStats();
            }
        });
    }

    initializeDatePicker();

    // 숫자 포맷팅 함수 추가
    function formatNumber(num) {
        if (!num || num === 0) return '0';
        if (num >= 1000000) {
            return (num / 1000000).toFixed(1) + 'M';
        } else if (num >= 1000) {
            return (num / 1000).toFixed(1) + 'K';
        }
        return num.toString();
    }
    
    // === 태그 추출 기능 ===
    const tagExtractForm = document.getElementById('tag-extract-form');
    const tagUrlInput = document.getElementById('tag-url-input');
    const extractTagsBtn = document.getElementById('extract-tags-btn');
    const tagLoading = document.getElementById('tag-loading');
    const tagError = document.getElementById('tag-error');
    const tagResultsContainer = document.getElementById('tag-results-container');
    const videoInfoSection = document.getElementById('video-info-section');
    const tagsSection = document.getElementById('tags-section');
    const tagsContainer = document.getElementById('tags-container');
    const tagsCount = document.getElementById('tags-count');
    
    if (tagExtractForm) {
        tagExtractForm.addEventListener('submit', function(event) {
            event.preventDefault();
            extractTags();
        });
    }
    
    function extractTags() {
        const url = tagUrlInput.value.trim();
        
        if (!url) {
            showTagError('URL을 입력해주세요.');
            return;
        }
        
        if (!isValidYouTubeUrl(url)) {
            showTagError('유효한 YouTube URL을 입력해주세요.');
            return;
        }
        
        // UI 상태 변경
        setTagExtractionLoading(true);
        hideTagError();
        hideTagResults();
        
        // API 호출
        fetch('/trending/api/extract-tags/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({ url: url })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayTagResults(data.data);
            } else {
                showTagError(data.error || '태그 추출에 실패했습니다.');
            }
        })
        .catch(error => {
            console.error('태그 추출 오류:', error);
            showTagError('서버 오류가 발생했습니다.');
        })
        .finally(() => {
            setTagExtractionLoading(false);
        });
    }
    
    function isValidYouTubeUrl(url) {
        const youtubePatterns = [
            /^https?:\/\/(?:www\.)?youtube\.com\/watch\?v=[\w-]+/,
            /^https?:\/\/youtu\.be\/[\w-]+/,
            /^https?:\/\/(?:www\.)?youtube\.com\/shorts\/[\w-]+/,
            /^https?:\/\/m\.youtube\.com\/watch\?v=[\w-]+/
        ];
        
        return youtubePatterns.some(pattern => pattern.test(url));
    }
    
    function setTagExtractionLoading(isLoading) {
        if (extractTagsBtn) {
            extractTagsBtn.disabled = isLoading;
            if (isLoading) {
                extractTagsBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 추출 중...';
            } else {
                extractTagsBtn.innerHTML = '<i class="fas fa-search"></i> 추출';
            }
        }
        
        if (tagLoading) {
            tagLoading.style.display = isLoading ? 'block' : 'none';
        }
    }
    
    function showTagError(message) {
        if (tagError) {
            tagError.textContent = message;
            tagError.style.display = 'block';
        }
    }
    
    function hideTagError() {
        if (tagError) {
            tagError.style.display = 'none';
        }
    }
    
    function hideTagResults() {
        if (tagResultsContainer) {
            tagResultsContainer.style.display = 'none';
        }
    }
    
    function displayTagResults(data) {
        // 비디오 정보 표시
        displayVideoInfo(data);
        
        // 태그 표시
        displayTags(data.tags);
        
        // 결과 컨테이너 표시
        if (tagResultsContainer) {
            tagResultsContainer.style.display = 'block';
        }
    }
    
    function displayVideoInfo(data) {
        // 썸네일
        const videoThumbnail = document.getElementById('video-thumbnail');
        const videoThumbImg = document.getElementById('video-thumb-img');
        if (data.thumbnail && videoThumbImg && videoThumbnail) {
            videoThumbImg.src = data.thumbnail;
            videoThumbnail.style.display = 'block';
        }
        
        // 제목
        const videoTitle = document.getElementById('video-title');
        if (videoTitle) {
            videoTitle.textContent = data.title;
            videoTitle.title = data.title; // 툴팁으로 전체 제목 표시
        }
        
        // 채널명
        const videoChannel = document.getElementById('video-channel');
        if (videoChannel) {
            const channelSpan = videoChannel.querySelector('span');
            if (channelSpan) {
                channelSpan.textContent = data.channel;
            } else {
                videoChannel.textContent = data.channel;
            }
        }
        
        // 재생시간
        const videoDuration = document.getElementById('video-duration');
        if (videoDuration) {
            videoDuration.textContent = data.duration;
        }
        
        // 조회수
        const videoViews = document.getElementById('video-views');
        if (videoViews) {
            videoViews.textContent = formatNumber(data.view_count) + ' 조회';
        }

        // 비디오 정보 섹션 표시
        if (videoInfoSection) {
            videoInfoSection.style.display = 'block';
        }

        // 기본 상태 메시지 숨기기
        const tagDefaultMessage = document.getElementById('tag-default-message');
        if (tagDefaultMessage) {
            tagDefaultMessage.style.display = 'none';
        }
    }
    
    function displayTags(tags) {
        if (!tagsContainer || !tagsCount) return;
        
        // 태그 개수 업데이트
        tagsCount.textContent = tags.length;
        
        // 태그 컨테이너 초기화
        tagsContainer.innerHTML = '';
        
        if (tags.length === 0) {
            tagsContainer.innerHTML = '<p class="text-muted text-center py-3">추출된 태그가 없습니다.</p>';
            return;
        }
        
        // 태그 렌더링 (순차적 애니메이션)
        tags.forEach((tag, index) => {
            const tagElement = createTagElement(tag, index);
            tagsContainer.appendChild(tagElement);
        });
    }
    
    function createTagElement(tag, index) {
        const tagElement = document.createElement('span');
        tagElement.className = `tag-item tag-${tag.category}`;
        tagElement.textContent = tag.text;
        tagElement.title = `카테고리: ${tag.category} | 길이: ${tag.length}자 | 클릭하여 선택`;
        
        // 초기 상태 설정 (애니메이션을 위해)
        tagElement.style.animationDelay = `${index * 0.1}s`;
        
        // 클릭 이벤트 (선택/해제)
        tagElement.addEventListener('click', function() {
            this.classList.toggle('selected');
        });
        
        return tagElement;
    }

    // 전체 태그 복사 기능
    const copyAllTagsBtn = document.getElementById('copy-all-tags-btn');
    if (copyAllTagsBtn) {
        copyAllTagsBtn.addEventListener('click', function() {
            copyAllTags();
        });
    }

    function copyAllTags() {
        const allTags = Array.from(tagsContainer.querySelectorAll('.tag-item'))
            .map(el => el.textContent);
        
        if (allTags.length === 0) {
            showNotification('복사할 태그가 없습니다.', 'warning');
            return;
        }
        
        const tagText = allTags.join(', ');
        
        if (navigator.clipboard) {
            navigator.clipboard.writeText(tagText).then(() => {
                showNotification(`${allTags.length}개 태그가 복사되었습니다.`, 'success');
            }).catch(err => {
                console.error('클립보드 복사 실패:', err);
                showNotification('복사에 실패했습니다.', 'danger');
            });
        } else {
            // 구형 브라우저 지원
            const textArea = document.createElement('textarea');
            textArea.value = tagText;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showNotification(`${allTags.length}개 태그가 복사되었습니다.`, 'success');
            } catch (err) {
                showNotification('복사에 실패했습니다.', 'danger');
            }
            document.body.removeChild(textArea);
        }
    }

    // 선택된 태그 복사 기능
    function copySelectedTags() {
        const selectedTags = Array.from(tagsContainer.querySelectorAll('.tag-item.selected'))
            .map(el => el.textContent);
        
        if (selectedTags.length === 0) {
            showNotification('선택된 태그가 없습니다.', 'warning');
            return;
        }
        
        const tagText = selectedTags.join(', ');
        
        if (navigator.clipboard) {
            navigator.clipboard.writeText(tagText).then(() => {
                showNotification(`${selectedTags.length}개 태그가 복사되었습니다.`, 'success');
            }).catch(err => {
                console.error('클립보드 복사 실패:', err);
                showNotification('복사에 실패했습니다.', 'danger');
            });
        } else {
            // 구형 브라우저 지원
            const textArea = document.createElement('textarea');
            textArea.value = tagText;
            document.body.appendChild(textArea);
            textArea.select();
            try {
                document.execCommand('copy');
                showNotification(`${selectedTags.length}개 태그가 복사되었습니다.`, 'success');
            } catch (err) {
                showNotification('복사에 실패했습니다.', 'danger');
            }
            document.body.removeChild(textArea);
        }
    }

    // 키보드 단축키 지원 개선
    document.addEventListener('keydown', function(event) {
        // 태그 추출 탭이 활성화된 상태에서만 동작
        const tagExtractorTab = document.getElementById('tag-extractor-panel');
        if (!tagExtractorTab || !tagExtractorTab.classList.contains('active')) {
            return;
        }
        
        // Ctrl+C 또는 Cmd+C로 선택된 태그 복사
        if ((event.ctrlKey || event.metaKey) && event.key === 'c') {
            const selectedTags = document.querySelectorAll('#tags-container .tag-item.selected');
            if (selectedTags.length > 0) {
                event.preventDefault();
                copySelectedTags();
            }
        }
        
        // Ctrl+A 또는 Cmd+A로 모든 태그 선택
        if ((event.ctrlKey || event.metaKey) && event.key === 'a') {
            const tagItems = document.querySelectorAll('#tags-container .tag-item');
            if (tagItems.length > 0) {
                event.preventDefault();
                tagItems.forEach(tag => tag.classList.add('selected'));
                showNotification(`${tagItems.length}개 태그가 선택되었습니다.`, 'info');
            }
        }
    });
});
</script>
{% endblock %} 