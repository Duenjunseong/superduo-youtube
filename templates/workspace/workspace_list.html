{% extends "base.html" %}
{% load widget_tweaks %}

{% block title %}워크스페이스 목록{% endblock %}

{% block extra_css %}
<style>
    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    
    .workspace-card {
        transition: all 0.3s ease;
        border: none;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .workspace-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15);
    }
    
    .workspace-avatar {
        width: 50px;
        height: 50px;
        border-radius: 12px;
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
        font-size: 1.2rem;
        margin-bottom: 1rem;
    }
    
    .invitation-alert {
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        border: none;
        border-radius: 16px;
        border-left: 5px solid #2196f3;
    }
    
    .invitation-item {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    
    .empty-state {
        padding: 4rem 2rem;
        text-align: center;
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 20px;
        margin: 2rem 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- 페이지 헤더 -->
    <div class="page-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1 class="mb-2">
                    <i class="fas fa-building me-3"></i>내 워크스페이스
                </h1>
                <p class="mb-0 opacity-90">참여하고 있는 워크스페이스를 관리하세요</p>
            </div>
            <div class="d-flex gap-2">
                <a href="{% url 'workspace:public_workspaces' %}" class="btn btn-light">
                    <i class="fas fa-search me-2"></i>공개 워크스페이스 찾기
                </a>
                <a href="{% url 'workspace:workspace_create' %}" class="btn btn-success">
                    <i class="fas fa-plus me-2"></i>새 워크스페이스
                </a>
            </div>
        </div>
    </div>

    <!-- 대기 중인 초대 -->
    {% if pending_invitations %}
    <div class="alert invitation-alert">
        <h5 class="d-flex align-items-center mb-3">
            <i class="fas fa-envelope me-2"></i>대기 중인 초대 ({{ pending_invitations.count }}개)
        </h5>
        {% for invitation in pending_invitations %}
        <div class="invitation-item">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1">
                    <div class="d-flex align-items-center mb-2">
                        <div class="workspace-avatar me-3" style="width: 40px; height: 40px; font-size: 1rem;">
                            {{ invitation.workspace.name.0|upper }}
                        </div>
                        <div>
                            <h6 class="mb-0 fw-bold">{{ invitation.workspace.name }}</h6>
                            <small class="text-muted">
                                <i class="fas fa-user me-1"></i>{{ invitation.inviter.username }}님이 초대
                                <span class="mx-2">•</span>
                                <i class="fas fa-clock me-1"></i>{{ invitation.created_at|date:"Y-m-d H:i" }}
                            </small>
                        </div>
                    </div>
                    
                    <div class="mb-2">
                        <span class="badge 
                            {% if invitation.role == 'ADMIN' %}bg-primary
                            {% elif invitation.role == 'MEMBER' %}bg-success
                            {% else %}bg-secondary{% endif %}">
                            {{ invitation.get_role_display }}
                        </span>
                    </div>
                    
                    {% if invitation.message %}
                    <p class="text-muted small mb-0 fst-italic">"{{ invitation.message }}"</p>
                    {% endif %}
                </div>
                
                <div class="ms-3">
                    <form method="post" action="{% url 'workspace:invitation_response' invitation_id=invitation.invitation_id %}" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" name="action" value="accept" class="btn btn-sm btn-success me-2">
                            <i class="fas fa-check me-1"></i>수락
                        </button>
                        <button type="submit" name="action" value="decline" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-times me-1"></i>거절
                        </button>
                    </form>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- 워크스페이스 목록 -->
    {% if workspaces %}
    <div class="row g-4">
        {% for workspace in workspaces %}
        <div class="col-md-6 col-xl-4">
            <div class="card workspace-card h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        {% if workspace.icon_url %}
                        <img src="{{ workspace.icon_url }}" 
                             alt="{{ workspace.name }} 아이콘" 
                             class="workspace-avatar"
                             style="object-fit: cover;">
                        {% else %}
                        <div class="workspace-avatar">
                            {{ workspace.name.0|upper }}
                        </div>
                        {% endif %}
                        <div class="d-flex gap-2">
                            {% if workspace.is_public %}
                            <span class="badge bg-success">
                                <i class="fas fa-globe me-1"></i>공개
                            </span>
                            {% else %}
                            <span class="badge bg-secondary">
                                <i class="fas fa-lock me-1"></i>비공개
                            </span>
                            {% endif %}
                            
                            {% if workspace.owner == user %}
                            <span class="badge bg-danger">
                                <i class="fas fa-crown me-1"></i>소유자
                            </span>
                            {% else %}
                            <span class="badge bg-primary">
                                <i class="fas fa-user me-1"></i>{{ workspace.get_user_role|default:"멤버" }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <h5 class="card-title mb-2">
                        <a href="{% url 'workspace:workspace_detail' workspace_id=workspace.workspace_id %}" 
                           class="text-decoration-none text-dark">
                            {{ workspace.name }}
                        </a>
                    </h5>
                    
                    {% if workspace.description %}
                    <p class="card-text text-muted small mb-3">{{ workspace.description|truncatechars:80 }}</p>
                    {% else %}
                    <p class="card-text text-muted small mb-3 fst-italic">설명이 없습니다.</p>
                    {% endif %}
                    
                    <!-- 워크스페이스 통계 -->
                    <div class="row g-2 text-center mb-3">
                        <div class="col-4">
                            <div class="fw-bold text-primary">{{ workspace.memberships.count }}</div>
                            <small class="text-muted">멤버</small>
                        </div>
                        <div class="col-4">
                            <div class="fw-bold text-success">{{ workspace.task_groups.count }}</div>
                            <small class="text-muted">그룹</small>
                        </div>
                        <div class="col-4">
                            <div class="fw-bold text-info">{{ workspace.processing_jobs.count }}</div>
                            <small class="text-muted">작업</small>
                        </div>
                    </div>
                </div>
                
                <div class="card-footer bg-transparent border-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <i class="fas fa-calendar me-1"></i>{{ workspace.created_at|date:"Y-m-d" }}
                        </small>
                        
                        {% if user.current_workspace.workspace_id != workspace.workspace_id %}
                        <form method="post" action="{% url 'workspace:switch_workspace' %}" class="d-inline">
                            {% csrf_token %}
                            <input type="hidden" name="workspace_id" value="{{ workspace.workspace_id }}">
                            <button type="submit" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-exchange-alt me-1"></i>전환
                            </button>
                        </form>
                        {% else %}
                        <span class="badge bg-success">
                            <i class="fas fa-check me-1"></i>현재 활성
                        </span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- 페이지네이션 -->
    {% if is_paginated %}
    <nav aria-label="워크스페이스 페이지네이션" class="mt-4">
        <ul class="pagination justify-content-center">
            {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1">
                    <i class="fas fa-angle-double-left"></i>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}">
                    <i class="fas fa-angle-left"></i>
                </a>
            </li>
            {% endif %}

            {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
            <li class="page-item active">
                <span class="page-link">{{ num }}</span>
            </li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
            <li class="page-item">
                <a class="page-link" href="?page={{ num }}">{{ num }}</a>
            </li>
            {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}">
                    <i class="fas fa-angle-right"></i>
                </a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}">
                    <i class="fas fa-angle-double-right"></i>
                </a>
            </li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
    
    {% else %}
    <div class="empty-state">
        <i class="fas fa-building fa-4x text-muted mb-4"></i>
        <h3 class="text-muted mb-3">참여한 워크스페이스가 없습니다</h3>
        <p class="text-muted mb-4">새 워크스페이스를 만들거나 공개 워크스페이스에 참여해보세요.</p>
        <div class="d-flex gap-3 justify-content-center">
            <a href="{% url 'workspace:workspace_create' %}" class="btn btn-primary btn-lg">
                <i class="fas fa-plus me-2"></i>새 워크스페이스 만들기
            </a>
            <a href="{% url 'workspace:public_workspaces' %}" class="btn btn-outline-primary btn-lg">
                <i class="fas fa-search me-2"></i>공개 워크스페이스 찾기
            </a>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %} 