{% extends "base.html" %}
{% load widget_tweaks %}

{% block title %}
{% if object %}
워크스페이스 수정 - {{ object.name }}
{% else %}
새 워크스페이스 생성
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
    .icon-preview {
        width: 120px;
        height: 120px;
        border-radius: 16px;
        border: 2px dashed #dee2e6;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-bottom: 1rem;
        background: #f8f9fa;
        transition: all 0.2s ease;
        flex-shrink: 0;
        aspect-ratio: 1;
        overflow: hidden;
    }
    
    .icon-preview:hover {
        border-color: #007bff;
        background: #e3f2fd;
    }
    
    .icon-preview img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        border-radius: 14px;
    }
    
    .icon-placeholder {
        color: #6c757d;
        font-size: 3rem;
    }
    
    .form-card {
        background: white;
        border-radius: 16px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: none;
    }
    
    .form-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 16px 16px 0 0;
        padding: 1.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8 col-lg-6">
            <div class="card form-card">
                <div class="form-header">
                    <h4 class="mb-0">
                        {% if object %}
                        <i class="fas fa-edit me-2"></i>워크스페이스 수정
                        {% else %}
                        <i class="fas fa-plus me-2"></i>새 워크스페이스 생성
                        {% endif %}
                    </h4>
                </div>
                <div class="card-body p-4">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        
                        <!-- 아이콘 업로드 -->
                        <div class="mb-4">
                            {{ form.icon.label_tag }}
                            <div class="d-flex align-items-start">
                                <div class="icon-preview me-3">
                                    {% if object and object.icon_url %}
                                    <img src="{{ object.icon_url }}" alt="현재 아이콘" id="iconPreview">
                                    {% else %}
                                    <div class="icon-placeholder" id="iconPlaceholder">
                                        <i class="fas fa-image"></i>
                                    </div>
                                    {% endif %}
                                </div>
                                <div class="flex-grow-1">
                                    {{ form.icon|add_class:"form-control" }}
                                    {% if form.icon.errors %}
                                        <div class="text-danger small mt-1">
                                            {{ form.icon.errors }}
                                        </div>
                                    {% endif %}
                                    {% if form.icon.help_text %}
                                        <div class="form-text">{{ form.icon.help_text }}</div>
                                    {% endif %}
                                    {% if object and object.icon %}
                                    <div class="form-check mt-2">
                                        <input type="checkbox" name="icon-clear" id="icon-clear_id" class="form-check-input">
                                        <label for="icon-clear_id" class="form-check-label">현재 아이콘 삭제</label>
                                    </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>

                        <!-- 워크스페이스명 -->
                        <div class="mb-3">
                            {{ form.name.label_tag }}
                            {{ form.name|add_class:"form-control" }}
                            {% if form.name.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.name.errors }}
                                </div>
                            {% endif %}
                            {% if form.name.help_text %}
                                <div class="form-text">{{ form.name.help_text }}</div>
                            {% endif %}
                        </div>

                        <!-- 설명 -->
                        <div class="mb-3">
                            {{ form.description.label_tag }}
                            {{ form.description|add_class:"form-control" }}
                            {% if form.description.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.description.errors }}
                                </div>
                            {% endif %}
                            {% if form.description.help_text %}
                                <div class="form-text">{{ form.description.help_text }}</div>
                            {% endif %}
                        </div>

                        <!-- 공개 여부 -->
                        <div class="mb-3">
                            <div class="form-check">
                                {{ form.is_public|add_class:"form-check-input" }}
                                {{ form.is_public.label_tag }}
                                {% if form.is_public.errors %}
                                    <div class="text-danger small mt-1">
                                        {{ form.is_public.errors }}
                                    </div>
                                {% endif %}
                            </div>
                            {% if form.is_public.help_text %}
                                <div class="form-text">{{ form.is_public.help_text }}</div>
                            {% endif %}
                        </div>

                        <!-- 최대 멤버 수 -->
                        <div class="mb-3">
                            {{ form.max_members.label_tag }}
                            {{ form.max_members|add_class:"form-control" }}
                            {% if form.max_members.errors %}
                                <div class="text-danger small mt-1">
                                    {{ form.max_members.errors }}
                                </div>
                            {% endif %}
                            {% if form.max_members.help_text %}
                                <div class="form-text">{{ form.max_members.help_text }}</div>
                            {% endif %}
                        </div>

                        <!-- 폼 전체 에러 -->
                        {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {{ form.non_field_errors }}
                        </div>
                        {% endif %}

                        <!-- 버튼 -->
                        <div class="d-flex justify-content-between">
                            <a href="{% if object %}{% url 'workspace:workspace_detail' workspace_id=object.workspace_id %}{% else %}{% url 'workspace:workspace_list' %}{% endif %}" 
                               class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i>취소
                            </a>
                            <button type="submit" class="btn btn-primary">
                                {% if object %}
                                <i class="fas fa-check me-2"></i>수정 완료
                                {% else %}
                                <i class="fas fa-plus me-2"></i>워크스페이스 생성
                                {% endif %}
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            {% if object %}
            <!-- 수정 시에만 추가 정보 표시 -->
            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>워크스페이스 정보</h6>
                </div>
                <div class="card-body">
                    <dl class="row">
                        <dt class="col-sm-4">생성일:</dt>
                        <dd class="col-sm-8">{{ object.created_at|date:"Y년 m월 d일 H:i" }}</dd>
                        
                        <dt class="col-sm-4">소유자:</dt>
                        <dd class="col-sm-8">{{ object.owner.username }}</dd>
                        
                        <dt class="col-sm-4">현재 멤버 수:</dt>
                        <dd class="col-sm-8">{{ object.member_count }}명</dd>
                        
                        <dt class="col-sm-4">워크스페이스 ID:</dt>
                        <dd class="col-sm-8"><code>{{ object.workspace_id }}</code></dd>
                    </dl>
                </div>
            </div>
            
            <!-- 소유자만 볼 수 있는 위험 구역 -->
            {% if object.owner == user %}
            <div class="card mt-4 border-danger">
                <div class="card-header bg-danger text-white">
                    <h6 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>위험 구역
                    </h6>
                </div>
                <div class="card-body">
                    <h6 class="text-danger">워크스페이스 삭제</h6>
                    <p class="text-muted mb-3">
                        워크스페이스를 삭제하면 모든 멤버, 작업 그룹, 초대가 제거되며 이 작업은 되돌릴 수 없습니다.
                    </p>
                    <a href="{% url 'workspace:workspace_delete' workspace_id=object.workspace_id %}" 
                       class="btn btn-danger">
                        <i class="fas fa-trash-alt me-2"></i>워크스페이스 삭제
                    </a>
                </div>
            </div>
            {% endif %}
            {% endif %}
        </div>
    </div>
</div>

<script>
// 아이콘 미리보기 기능
document.getElementById('id_icon').addEventListener('change', function(e) {
    const file = e.target.files[0];
    const preview = document.getElementById('iconPreview');
    const placeholder = document.getElementById('iconPlaceholder');
    
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            if (preview) {
                preview.src = e.target.result;
            } else {
                // 새로운 이미지 요소 생성
                const img = document.createElement('img');
                img.src = e.target.result;
                img.alt = '아이콘 미리보기';
                img.id = 'iconPreview';
                
                // placeholder를 이미지로 교체
                const iconPreviewContainer = placeholder.parentElement;
                iconPreviewContainer.removeChild(placeholder);
                iconPreviewContainer.appendChild(img);
            }
        };
        reader.readAsDataURL(file);
    }
});
</script>
{% endblock %} 